<div class="card">
  <h2 class="ttl">Trabajo de Título</h2>

  <div class="tabs">
    <button [class.active]="tab() === 'i'" (click)="tab.set('i')">T. Título I</button>
    <button [class.active]="tab() === 'ii'" (click)="tab.set('ii')">T. Título II</button>
    <button [class.active]="tab() === 'temas'" (click)="tab.set('temas')">Temas</button>
  </div>

  <!-- GRUPOS (TT I / TT II) -->
  <ng-container *ngIf="tab() !== 'temas'; else temasTpl">
    <p class="subtitle">Sus grupos asignados</p>

    <ul class="list">
      <li *ngFor="let g of grupos()">
        <div class="grupo-info">
          <div class="grupo-nombre">
            {{ g.nombre }}
            <span *ngIf="g.alert" class="alert-icon">{{ g.alert }}</span>
            <span *ngIf="g.status === 'check'" class="status-icon" aria-label="OK">✓</span>
          </div>
          <div class="grupo-alumnos">{{ g.alumnos }}</div>
        </div>

        <!-- Navegación al detalle -->
        <a
          class="btn sm"
          [routerLink]="['/docente/trabajodetalle']"
          [queryParams]="{ nivel: tab(), grupo: g.id }"
          >Ver</a
        >
      </li>
    </ul>
  </ng-container>

 <!-- TEMAS -->
    <ng-template #temasTpl>
      <div class="row-head">
        <h3>Temas disponibles</h3>
        <button type="button" class="btn primary" (click)="toggleTemaModal(true)">
          + Agregar tema
        </button>
      </div>
      <p class="muted">Gestiona los temas para ofrecer a tus estudiantes.</p>


      <div class="backdrop" *ngIf="showTemaModal()" (click)="toggleTemaModal(false)"></div>
      <div class="modal" *ngIf="showTemaModal()" role="dialog" aria-modal="true">
        <div class="modal-head">
          <h4 class="ttl" style="margin: 0">Nuevo tema</h4>
          <button
            type="button"
            class="icon"
            (click)="toggleTemaModal(false)"
            aria-label="Cerrar"
          >
            ✕
          </button>
        </div>

        <form [formGroup]="temaForm" (ngSubmit)="submitTema()" class="grid" novalidate>
          <div class="field full">
            <label for="tema-titulo">Nombre del tema <span class="req">*</span></label>
            <input id="tema-titulo" type="text" formControlName="titulo" />
            <div class="err" *ngIf="hasTemaError('titulo', 'required')">Obligatorio.</div>
            <div class="err" *ngIf="hasTemaError('titulo', 'maxlength')">Máx. 160 caracteres.</div>
          </div>

          <div class="field full">
            <label for="tema-objetivo">Objetivo <span class="req">*</span></label>
            <input id="tema-objetivo" type="text" formControlName="objetivo" />
            <div class="err" *ngIf="hasTemaError('objetivo', 'required')">Obligatorio.</div>
            <div class="err" *ngIf="hasTemaError('objetivo', 'maxlength')">Máx. 300 caracteres.</div>
          </div>

          <div class="field full">
            <label for="tema-descripcion">Breve descripción <span class="req">*</span></label>
            <textarea id="tema-descripcion" rows="5" formControlName="descripcion"></textarea>
            <div class="err" *ngIf="hasTemaError('descripcion', 'required')">Obligatorio.</div>
            <div class="err" *ngIf="hasTemaError('descripcion', 'maxlength')">Máx. 1200 caracteres.</div>
          </div>
    
          <div class="field">
            <label for="tema-rama">Rama de la carrera <span class="req">*</span></label>
            <select id="tema-rama" formControlName="rama">
              <option value="" disabled>Selecciona una rama</option>
              <option *ngFor="let r of ramas" [value]="r">{{ r }}</option>
            </select>
            <div class="err" *ngIf="hasTemaError('rama', 'required')">Selecciona una rama.</div>
          </div>

          <div class="actions full">
            <button type="button" class="btn light" (click)="toggleTemaModal(false)">
              Cancelar
            </button>
            <button type="submit" class="btn primary" [disabled]="enviarTema()">
              {{ enviarTema() ? 'Guardando...' : 'Guardar tema' }}
            </button>
          </div>
   

          <div class="err" *ngIf="enviarTemaError()">{{ enviarTemaError() }}</div>
        </form>
      </div>

      <ng-container *ngIf="temasCargando(); else temasCargados">
        <p class="muted" style="margin-top: 1rem">Cargando temas...</p>
      </ng-container>

      <ng-template #temasCargados>
        <div class="err" *ngIf="temasError(); else temasLista">{{ temasError() }}</div>
      </ng-template>

      <ng-template #sinTemas>
        <p class="muted" style="margin-top: 1rem">No hay temas disponibles por ahora.</p>
      </ng-template>

      <ng-template #temasLista>
        <ul class="list topics" *ngIf="temas().length; else sinTemas">
          <li *ngFor="let t of temas()">
            <div class="grupo-info">
              <div class="grupo-nombre">
                {{ t.titulo }}
                <span class="badge">{{ t.carrera }}</span>
              </div>
              <div class="grupo-alumnos">{{ t.descripcion }}</div>

              <div class="chips">
                <span class="chip" *ngFor="let r of t.requisitos">{{ r }}</span>
                <span class="chip ghost">Cupos: {{ t.cupos }}</span>
              </div>
            </div>

            <button class="btn sm" type="button">Publicar</button>
          </li>
        </ul>
      </ng-template>
    </ng-template>
</div>
