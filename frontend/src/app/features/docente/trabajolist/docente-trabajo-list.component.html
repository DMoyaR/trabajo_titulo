<h2 class="ttl">Trabajo de T√≠tulo</h2>

<div class="tabs">
  <button [class.active]="tab === 'titulo1'" (click)="tab = 'titulo1'; volverAListaGrupos()">T. T√≠tulo I</button>
  <button [class.active]="tab === 'titulo2'" (click)="tab = 'titulo2'; volverAListaGrupos()">T. T√≠tulo II</button>
  <button [class.active]="tab === 'temas'"   (click)="tab = 'temas'">Temas</button>
</div>

<!-- T√çTULO I / II -->
<div *ngIf="tab === 'titulo1' || tab === 'titulo2'">
  <!-- Lista de grupos -->
  <ng-container *ngIf="!grupoSeleccionado; else panelEntregas">
    <h3>Grupos asignados</h3>

    <div class="grupos-container">
      <div class="grupo-card" *ngFor="let grupo of (tab==='titulo1' ? gruposTitulo1 : gruposTitulo2)">
        <div class="grupo-info">
          <div class="grupo-nombre">{{ grupo.nombre }}</div>
          <div class="grupo-integrantes">{{ grupo.integrantes.join(' / ') }}</div>
        </div>

        <div class="grupo-actions">
          <span class="chip-status" [ngClass]="estadoClase(grupo.estado)">
            {{ estadoTexto(grupo.estado) }}
          </span>
          <button class="btn-ver" (click)="verGrupo(grupo)">Ver</button>
        </div>
      </div>
    </div>
  </ng-container>

  <!-- Panel de ENTREGAS DEL GRUPO -->
  <ng-template #panelEntregas>
    <div class="row-head">
      <div style="display:flex; align-items:center; gap:10px;">
        <button class="btn light" (click)="volverAListaGrupos()">‚Üê Volver</button>
        <h3 style="margin:0">Entregas ‚Äî {{ grupoSeleccionado?.nombre }}</h3>
      </div>
      <div class="muted">{{ grupoSeleccionado?.integrantes?.join(' / ') }}</div>
    </div>

    <!-- Filtros -->
    <div class="filtros-bar">
      <select [(ngModel)]="filtroTipo">
        <option *ngFor="let t of tiposEntrega" [value]="t">{{ t }}</option>
      </select>
      <input type="text" [(ngModel)]="filtroBusqueda" placeholder="Buscar entrega..." />
    </div>

    <div class="entregas-grid">
      <!-- Pendientes -->
      <div class="col">
        <h4 class="sec">Pendientes</h4>
        <ng-container *ngIf="hasPendientes; else noPend">
          <div class="hit-card" *ngFor="let e of entregasFiltradas" [hidden]="e.estado!=='pendiente'">
            <div class="hit-head">
              <div class="hit-titulo">{{ e.titulo }}</div>
              <span class="chip chip-warn">Pendiente</span>
            </div>
            <div class="hit-descr muted">
              {{ e.tipo }} ‚Ä¢ <ng-container *ngIf="e.fechaLimite">Coordinar antes del {{ e.fechaLimite }}</ng-container>
            </div>
            <div class="hit-actions">
              <button class="btn primary" (click)="revisarEntrega(e)">Revisar</button>
            </div>
          </div>
        </ng-container>
        <ng-template #noPend>
          <p class="muted">No hay entregas pendientes seg√∫n los filtros.</p>
        </ng-template>
      </div>

      <!-- Evaluadas -->
      <div class="col">
        <h4 class="sec">Evaluadas</h4>
        <ng-container *ngIf="hasEvaluadas; else noEval">
          <div class="hit-card" *ngFor="let e of entregasFiltradas" [hidden]="e.estado!=='evaluado'">
            <div class="hit-head">
              <div class="hit-titulo">{{ e.titulo }}</div>
              <span class="chip chip-ok">Evaluada</span>
            </div>
            <div class="hit-meta muted">
              Entregada {{ e.fechaEntrega }} ‚Ä¢ Nota: <b>{{ e.nota }}</b>
            </div>
            <div class="hit-actions">
              <button class="btn light" (click)="toggleResumen(e)">
                {{ e.expanded ? 'Ocultar resumen' : 'Ver resumen' }}
              </button>
            </div>
            <div class="hit-resumen" *ngIf="e.expanded">
              <p class="muted"><b>Comentarios:</b></p>
              <p>{{ e.comentarios }}</p>
            </div>
          </div>
        </ng-container>
        <ng-template #noEval>
          <p class="muted">No hay entregas evaluadas seg√∫n los filtros.</p>
        </ng-template>
      </div>
    </div>
  </ng-template>
</div>

<!-- TEMAS -->
<div *ngIf="tab === 'temas'">
  <div class="row-head">
    <h3>Temas disponibles</h3>
    <div style="display:flex; gap:10px;">
      <button type="button" class="btn outline" (click)="togglePropuestasModal(true)">üìÑ Ver propuestas</button>
      <button type="button" class="btn primary" (click)="abrirModalTema()">+ Agregar tema</button>
    </div>
  </div>

  <ng-container *ngIf="temas.length > 0; else sinTemas">
    <ul class="temas-list">
      <li *ngFor="let tema of temas" class="temas-item">
        <div class="temas-item__header">
          <div>
            <h4 class="temas-item__title">{{ tema.titulo }}</h4>
            <p class="temas-item__objetivo">{{ tema.objetivo }}</p>
          </div>
          
        </div>

        <div class="temas-item__meta">
          <span class="chip ghost">Cupos: {{ tema.cupos }}</span>
          <span class="chip ghost">Fecha de publicaci√≥n: {{ tema.fecha | date:'shortDate' }}</span>
          <span class="badge">{{ tema.rama }}</span>
        </div>

        <div class="temas-item__actions">
          <button class="btn danger" (click)="eliminarTema(tema)" >Eliminar</button>
        </div>
      </li>
    </ul>
  </ng-container>
  <ng-template #sinTemas><p class="muted">No hay temas disponibles por ahora.</p></ng-template>
</div>

<!-- MODAL PROPUESAS -->
<div class="backdrop" *ngIf="showPropuestasModal" (click)="togglePropuestasModal(false)"></div>
<div class="modal" *ngIf="showPropuestasModal" role="dialog" aria-modal="true">
  <div class="modal-head">
    <h4 class="ttl" style="margin:0">Propuestas de Trabajo de T√≠tulo</h4>
    <button type="button" class="icon" (click)="togglePropuestasModal(false)">‚úï</button>
  </div>

  <div class="muted" *ngIf="propuestasCargando">Cargando propuestas...</div>
  <div class="err" *ngIf="propuestasError">{{ propuestasError }}</div>
  <p class="muted" *ngIf="!propuestasCargando && !propuestasError && !propuestas.length">No hay propuestas registradas por ahora.</p>

  <div class="tabla" *ngIf="!propuestasCargando && propuestas.length">
    <div class="head">
      <span>Alumno</span><span>Tema</span><span>Rama</span><span>Fecha</span><span>Estado</span><span></span>
    </div>
    <div *ngFor="let p of propuestas">
      <div class="fila">
        <div>{{ p.alumno?.nombre || 'Sin registro' }}</div>
        <div>{{ p.titulo }}</div>
        <div>{{ p.rama }}</div>
        <div>{{ p.createdAt | date:'shortDate' }}</div>
        <div>
          <span class="chip"
            [class.chip-ok]="p.estado==='aceptada'"
            [class.chip-bad]="p.estado==='rechazada'"
            [class.chip-warn]="p.estado==='pendiente'">{{ p.estado | titlecase }}</span>
        </div>
        <div><button class="btn sm" (click)="seleccionarPropuesta(p)">Revisar</button></div>
      </div>
    </div>
  </div>

  <div class="detalle" *ngIf="propuestaSeleccionada as sel">
    <h4>{{ sel.titulo }}</h4>
    <p><b>Alumno:</b> {{ sel.alumno?.nombre || 'Sin registro' }}</p>
    <p class="muted"><b>Rama:</b> {{ sel.rama }} ‚Äî <b>Creada:</b> {{ sel.createdAt | date:'short' }}</p>
    <p><b>Objetivo:</b> {{ sel.objetivo }}</p>
    <p><b>Descripci√≥n:</b> {{ sel.descripcion }}</p>
    <p *ngIf="sel.comentarioDecision" class="muted">√öltimo comentario registrado: {{ sel.comentarioDecision }}</p>

    <div class="form">
      <label for="comentario">Comentario</label>
      <textarea id="comentario" [(ngModel)]="comentarioDecision" placeholder="Fundamente su decisi√≥n..."></textarea>
      <div class="actions">
        <button class="btn primary" type="button" (click)="aceptarPropuesta()" [disabled]="!comentarioDecision || decisionEnCurso">Aceptar</button>
        <button class="btn danger"  type="button" (click)="rechazarPropuesta()" [disabled]="!comentarioDecision || decisionEnCurso">Rechazar</button>
      </div>
      <p class="muted" *ngIf="decisionEnCurso">Guardando decisi√≥n...</p>
    </div>
  </div>
</div>

<!-- MODAL NUEVO TEMA -->
<div class="backdrop" *ngIf="showModalTema" (click)="cerrarModalTema()"></div>
<div class="modal narrow" *ngIf="showModalTema" role="dialog" aria-modal="true">
  <div class="modal-head">
    <h4 class="ttl" style="margin:0">Nuevo tema</h4>
    <button type="button" class="icon" (click)="cerrarModalTema()">‚úï</button>
  </div>

  <form class="grid" (ngSubmit)="guardarTema()" novalidate>
    <div class="field">
      <label>Nombre del tema <span class="req">*</span></label>
      <input type="text" [(ngModel)]="nuevoTema.titulo" name="titulo" required />
    </div>

    <div class="field">
      <label>Objetivo <span class="req">*</span></label>
      <input type="text" [(ngModel)]="nuevoTema.objetivo" name="objetivo" required />
    </div>

    <div class="field full">
      <label>Breve descripci√≥n <span class="req">*</span></label>
      <textarea [(ngModel)]="nuevoTema.descripcion" name="descripcion" required></textarea>
    </div>

    <div class="field">
      <label>Rama de la carrera <span class="req">*</span></label>
      <select [(ngModel)]="nuevoTema.rama" name="rama" required>
        <option value="">Selecciona una rama</option>
        <option *ngFor="let r of ramas" [value]="r">{{ r }}</option>
      </select>
      <div class="err" *ngIf="!nuevoTema.rama">Obligatorio.</div>
    </div>

    <div class="field">
      <label>Cupos</label>
      <input type="number" [(ngModel)]="nuevoTema.cupos" name="cupos" min="1" />
    </div>

    <div class="field full">
      <label>Requisitos (separados por coma)</label>
      <input type="text" [(ngModel)]="nuevoTema.requisitos" name="requisitos" placeholder="Ej: Linux, Git, Metodolog√≠as √°giles"/>
    </div>

    <div class="actions full">
      <button type="button" class="btn light" (click)="cerrarModalTema()">Cancelar</button>
      <button type="submit" class="btn primary">Guardar tema</button>
    </div>
  </form>
</div>

<!-- MODAL EVALUACI√ìN -->
<div class="backdrop" *ngIf="showEvalModal" (click)="cerrarEvalModal()"></div>
<div class="modal narrow" *ngIf="showEvalModal" role="dialog" aria-modal="true">
  <div class="modal-head">
    <h4 class="ttl" style="margin:0">Evaluar entrega</h4>
    <button type="button" class="icon" (click)="cerrarEvalModal()">‚úï</button>
  </div>

  <form class="grid" (ngSubmit)="guardarEvaluacion()" novalidate>
    <div class="field full">
      <label>Entrega</label>
      <div class="readonly">{{ entregaEnRevision?.titulo }}</div>
      <div class="muted">{{ entregaEnRevision?.tipo }}</div>
    </div>

    <div class="field">
      <label>Nota (1.0 a 7.0) <span class="req">*</span></label>
      <input type="number" min="1" max="7" step="0.1" [(ngModel)]="notaInput" name="nota" required/>
    </div>

    <div class="field full">
      <label>Comentarios</label>
      <textarea [(ngModel)]="comentariosInput" name="comentarios" placeholder="Opcional, observaciones de la evaluaci√≥n"></textarea>
    </div>

    <div class="actions full">
      <button type="button" class="btn light" (click)="cerrarEvalModal()">Cancelar</button>
      <button type="submit" class="btn primary" [disabled]="notaInput==null">Guardar evaluaci√≥n</button>
    </div>
  </form>
</div>