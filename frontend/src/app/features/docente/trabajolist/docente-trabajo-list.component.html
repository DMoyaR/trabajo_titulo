<div class="card">
  <h2 class="ttl">Trabajo de T√≠tulo</h2>

  <div class="tabs">
    <button [class.active]="tab === 'titulo1'" (click)="tab = 'titulo1'; volverAListaGrupos()">T. T√≠tulo I</button>
    <button [class.active]="tab === 'titulo2'" (click)="tab = 'titulo2'; volverAListaGrupos()">T. T√≠tulo II</button>
    <a class="btn link" routerLink="/docente/temas">Gestionar temas</a>
  </div>

  <div *ngIf="tab === 'titulo1' || tab === 'titulo2'">
    <ng-container *ngIf="!grupoSeleccionado; else panelEntregas">
      <h3>Grupos asignados</h3>

      <p class="muted" *ngIf="cargandoGrupos">Cargando grupos‚Ä¶</p>
      <p class="error" *ngIf="!cargandoGrupos && errorGrupos">{{ errorGrupos }}</p>
      <p class="muted" *ngIf="!cargandoGrupos && !errorGrupos && !gruposActuales.length">
        A√∫n no tienes grupos con alumnos inscritos.
      </p>

      <div class="grupos-container" *ngIf="!cargandoGrupos && !errorGrupos && gruposActuales.length">
        <div class="grupo-card" *ngFor="let grupo of gruposActuales">
          <div class="grupo-info">
            <div class="grupo-nombre">{{ grupo.nombre }}</div>
            <div class="grupo-integrantes">{{ grupo.integrantes.join(' / ') }}</div>
          </div>

          <div class="grupo-actions">
            <span class="chip-status" [ngClass]="estadoClase(grupo.estado)">
              {{ estadoTexto(grupo.estado) }}
            </span>
            <button class="btn-ver" type="button" (click)="verGrupo(grupo)">Ver</button>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-template #panelEntregas>
      <div class="row-head">
        <div style="display:flex; align-items:center; gap:10px;">
          <button class="btn light" type="button" (click)="volverAListaGrupos()">‚Üê Volver</button>
          <h3 style="margin:0">Entregas ‚Äî {{ grupoSeleccionado?.nombre }}</h3>
        </div>
        <div class="muted">{{ grupoSeleccionado?.integrantes?.join(' / ') }}</div>
      </div>

      <p class="muted" *ngIf="cargandoEntregas">Cargando entregas‚Ä¶</p>
      <p class="error" *ngIf="!cargandoEntregas && errorEntregas">{{ errorEntregas }}</p>

      <div class="filtros-bar">
        <select [(ngModel)]="filtroTipo">
          <option *ngFor="let t of tiposEntrega" [value]="t">{{ t }}</option>
        </select>
        <input type="text" [(ngModel)]="filtroBusqueda" placeholder="Buscar entrega..." />
      </div>

      <div class="entregas-grid" *ngIf="!cargandoEntregas">
        <div class="col">
          <h4 class="sec">Pendientes</h4>
          <ng-container *ngIf="hasPendientes; else noPend">
            <div class="hit-card" *ngFor="let e of entregasFiltradas" [hidden]="e.estado!=='pendiente'">
              <div class="hit-head">
                <div class="hit-titulo">{{ e.titulo }}</div>
                <span class="chip chip-warn">Pendiente</span>
              </div>
              <div class="hit-descr muted">
                <span *ngIf="e.esBitacora" class="pill">Bit√°cora {{ e.bitacoraIndice || '-' }}</span>
                {{ e.tipo }} ‚Ä¢
                <ng-container *ngIf="e.fechaLimite">Coordinar antes del {{ e.fechaLimite }}</ng-container>
              </div>
              <div class="hit-meta" *ngIf="e.alumnoNombre || e.alumnoCorreo">
                <small class="muted">{{ e.alumnoNombre }} <span *ngIf="e.alumnoCorreo">({{ e.alumnoCorreo }})</span></small>
              </div>
              <div class="hit-files" *ngIf="e.archivoNombre">
                <div class="file-chip">
                  üìÑ {{ e.archivoNombre }}
                  <small class="muted" *ngIf="e.archivoTipo">({{ e.archivoTipo }})</small>
                </div>
                <a
                  class="btn link"
                  *ngIf="e.archivoUrl"
                  [href]="e.archivoUrl"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  Ver archivo
                </a>
              </div>
              <div class="hit-actions">
                <button class="btn primary" type="button" (click)="revisarEntrega(e)">Revisar</button>
              </div>
            </div>
          </ng-container>
          <ng-template #noPend>
            <p class="muted">No hay entregas pendientes seg√∫n los filtros.</p>
          </ng-template>
        </div>

        <div class="col">
          <h4 class="sec">Evaluadas</h4>
          <ng-container *ngIf="hasEvaluadas; else noEval">
            <div class="hit-card" *ngFor="let e of entregasFiltradas" [hidden]="e.estado!=='evaluado'">
              <div class="hit-head">
                <div class="hit-titulo">{{ e.titulo }}</div>
                <span class="chip chip-ok">Evaluada</span>
              </div>
              <div class="hit-meta muted">
                <span *ngIf="e.esBitacora" class="pill">Bit√°cora {{ e.bitacoraIndice || '-' }}</span>
                Entregada {{ e.fechaEntrega }}
                <span *ngIf="e.nota">‚Ä¢ Nota: <b>{{ e.nota }}</b></span>
              </div>
              <div class="hit-meta" *ngIf="e.alumnoNombre || e.alumnoCorreo">
                <small class="muted">{{ e.alumnoNombre }} <span *ngIf="e.alumnoCorreo">({{ e.alumnoCorreo }})</span></small>
              </div>
              <div class="hit-actions">
                <button class="btn light" type="button" (click)="toggleResumen(e)">
                  {{ e.expanded ? 'Ocultar resumen' : 'Ver resumen' }}
                </button>
              </div>
              <div class="hit-resumen" *ngIf="e.expanded">
                <p class="muted"><b>Comentarios:</b></p>
                <p>{{ e.comentarios }}</p>
                <div class="hit-files" *ngIf="e.archivoNombre || e.rubricaUrl || e.informeUrl">
                  <p class="muted"><b>Archivos adjuntos</b></p>
                  <div class="file-chip" *ngIf="e.archivoNombre">
                    üìÑ
                    <a [href]="e.archivoUrl || undefined" target="_blank" rel="noopener noreferrer">
                      {{ e.archivoNombre }}
                    </a>
                    <small class="muted" *ngIf="e.archivoTipo">({{ e.archivoTipo }})</small>
                  </div>
                  <div class="file-chip" *ngIf="e.rubricaUrl">
                    üìé
                    <a [href]="e.rubricaUrl" target="_blank" rel="noopener noreferrer">
                      {{ e.rubricaNombre || 'R√∫brica' }}
                    </a>
                    <small class="muted" *ngIf="e.rubricaTipo">({{ e.rubricaTipo }})</small>
                  </div>
                  <div class="file-chip" *ngIf="e.informeUrl">
                    üìù
                    <a [href]="e.informeUrl" target="_blank" rel="noopener noreferrer">
                      {{ e.informeNombre || 'Informe corregido' }}
                    </a>
                    <small class="muted" *ngIf="e.informeTipo">({{ e.informeTipo }})</small>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
          <ng-template #noEval>
            <p class="muted">No hay entregas evaluadas seg√∫n los filtros.</p>
          </ng-template>
        </div>
      </div>
    </ng-template>
  </div>

  <div class="backdrop" *ngIf="showEvalModal" (click)="cerrarEvalModal()"></div>
  <div class="modal narrow" *ngIf="showEvalModal" role="dialog" aria-modal="true">
    <div class="modal-head">
      <h4 class="ttl" style="margin:0">Evaluar entrega</h4>
      <button type="button" class="icon" (click)="cerrarEvalModal()">‚úï</button>
    </div>

    <form class="grid" (ngSubmit)="guardarEvaluacion()" novalidate>
      <div class="field full">
        <label>Entrega</label>
        <div class="readonly">{{ entregaEnRevision?.titulo }}</div>
        <div class="muted">{{ entregaEnRevision?.tipo }}</div>
      </div>

      <div class="field">
        <label>Nota (1.0 a 7.0) <span class="req">*</span></label>
        <input type="number" min="1" max="7" step="0.1" [(ngModel)]="notaInput" name="nota" required />
      </div>

      <div class="field">
        <label>R√∫brica con puntaje</label>
        <label class="file-picker">
          <input type="file" accept="application/pdf,.pdf" (change)="onRubricaSeleccionada($event)" />
          <span>{{ rubricaArchivo?.name || 'Subir r√∫brica (PDF)' }}</span>
        </label>
        <small class="muted">Adjunta la r√∫brica completa con el desglose de puntaje.</small>
      </div>

      <div class="field">
        <label>Informe con correcciones</label>
        <label class="file-picker">
          <input type="file" (change)="onInformeSeleccionado($event)" />
          <span>{{ informeArchivo?.name || 'Subir informe corregido' }}</span>
        </label>
        <small class="muted">Archivo con las observaciones y correcciones para el alumno.</small>
      </div>

      <div class="field full">
        <label>Comentarios</label>
        <textarea [(ngModel)]="comentariosInput" name="comentarios" placeholder="Opcional, observaciones de la evaluaci√≥n"></textarea>
      </div>

      <p class="error" *ngIf="errorEvaluacion">{{ errorEvaluacion }}</p>

      <div class="actions full">
        <button type="button" class="btn light" (click)="cerrarEvalModal()">Cancelar</button>
        <button type="submit" class="btn primary" [disabled]="notaInput==null || guardandoEvaluacion">
          {{ guardandoEvaluacion ? 'Guardando‚Ä¶' : 'Guardar evaluaci√≥n' }}
        </button>
      </div>
    </form>
  </div>
</div>