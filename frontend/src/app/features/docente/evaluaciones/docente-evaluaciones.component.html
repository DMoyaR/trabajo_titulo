<h2 class="ttl">Evaluaciones por grupo</h2>
<p class="description">
  Registra de forma manual las evaluaciones que realizará cada grupo. Completa la información del
  formulario y presiona <strong>Agregar evaluación</strong> para construir tu listado.
</p>

<form class="form" (submit)="agregarEvaluacion($event)">
  <div class="form-grid">
    <label class="field">
      <span>Grupo activo</span>
      <select
        [value]="grupoSeleccionadoId() ?? ''"
        (change)="onSeleccionGrupo($event)"
        [disabled]="cargandoGruposActivos() || !gruposActivos().length || enviando()"
      >
        <option value="" disabled hidden>
          {{ cargandoGruposActivos() ? 'Cargando grupos…' : 'Selecciona un grupo activo' }}
        </option>
        <option *ngFor="let grupo of gruposActivos()" [value]="grupo.id">
          {{ grupo.nombre }}{{ grupo.integrantes.length ? ' — ' + grupo.integrantes.join(' / ') : '' }}
        </option>
      </select>
      <small class="field-hint" *ngIf="cargandoGruposActivos()">Cargando grupos activos…</small>
      <small class="field-hint warning" *ngIf="!cargandoGruposActivos() && !gruposActivos().length && !errorGruposActivos()">
        No tienes grupos activos disponibles en este momento.
      </small>
      <small class="field-hint error" *ngIf="errorGruposActivos()">{{ errorGruposActivos() }}</small>
    </label>
    <label class="field">
      <span>Evaluación</span>
      <input
        type="text"
        placeholder="Ej: Revisión de avance"
        [value]="evaluacionTitulo()"
        (input)="evaluacionTitulo.set(($any($event.target)).value)"
      />
    </label>
    <label class="field">
      <span>Fecha (opcional)</span>
      <input
        type="date"
        [value]="evaluacionFecha()"
        (input)="evaluacionFecha.set(($any($event.target)).value)"
      />
    </label>
    <div class="field status-field">
      <span>Estado según fecha</span>
      <div class="status-preview" [ngClass]="estadoCalculado().toLowerCase().replace(' ', '-')">
        {{ estadoCalculado() }}
      </div>
    </div>
  </div>
  <button
    class="btn"
    type="submit"
    [disabled]="
      enviando() ||
      cargandoGruposActivos() ||
      !gruposActivos().length ||
      !grupoSeleccionadoId() ||
      !evaluacionTitulo().trim()
    "
  >
    {{ enviando() ? 'Guardando…' : 'Agregar evaluación' }}
  </button>
</form>

<p class="error" *ngIf="error()">{{ error() }}</p>

<ng-container *ngIf="!cargando(); else loadingState">
  <ng-container *ngIf="grupos().length; else emptyState">
    <div class="groups">
      <section class="group-card" *ngFor="let grupo of grupos()">
        <header>
          <h3>{{ grupo.nombre }}</h3>
          <span>{{ grupo.evaluaciones.length }} evaluaciones</span>
        </header>
        <ul>
          <li *ngFor="let evaluacion of grupo.evaluaciones">
            <h4>{{ evaluacion.titulo }}</h4>
            <p class="meta">
              <span *ngIf="evaluacion.fecha"
                >Fecha: {{ evaluacion.fecha | date: 'dd/MM/yyyy' }}</span
              >
              <span>Estado: {{ evaluacion.estado }}</span>
            </p>
          </li>
        </ul>
      </section>
    </div>
  </ng-container>
</ng-container>

<ng-template #emptyState>
  <ng-container *ngIf="!error(); else errorState">
    <div class="empty">
      <h3>Aún no has registrado evaluaciones</h3>
      <p>Comienza agregando el primer grupo desde el formulario de arriba.</p>
    </div>
  </ng-container>
</ng-template>

<ng-template #errorState>
  <div class="empty error-state">
    <h3>No pudimos cargar tus evaluaciones</h3>
    <p>Intenta recargar la página o agrega una nueva evaluación para comenzar.</p>
  </div>
</ng-template>

<ng-template #loadingState>
  <div class="loading">Cargando evaluaciones…</div>
</ng-template>
