<h2 class="ttl">Panel de docente</h2>

<h3 class="section-subtitle">Estudiantes Asignados</h3>

<div class="filters">
  <div class="filter-group">
    <label class="filter-label">Carrera</label>
    <select>
      <option>Todas las carreras</option>
      <option>Ingeniería en Sistemas</option>
      <option>Administración</option>
      <option>Ingeniería Industrial</option>
    </select>
  </div>
  <div class="filter-group">
    <label class="filter-label">Tipo de Proceso</label>
    <select>
      <option>Todos los tipos</option>
      <option>Tesis</option>
      <option>Prácticas</option>
      <option>Proyecto</option>
    </select>
  </div>
  <div class="filter-group">
    <label class="filter-label">Estado</label>
    <select>
      <option>Todos los estados</option>
      <option>Entregado</option>
      <option>En proceso</option>
      <option>Pendiente</option>
    </select>
  </div>
  <div class="filter-group">
    <label class="filter-label">Avance</label>
    <select>
      <option>Cualquier avance</option>
      <option>0-25%</option>
      <option>26-50%</option>
      <option>51-75%</option>
      <option>76-100%</option>
    </select>
  </div>
  <button class="btn sm">Filtrar</button>
</div>

<div class="grid">
  <div class="card main-table" aria-live="polite">
    <div class="card-head">
      <h3>Estudiantes asignados</h3>
      <span class="muted" *ngIf="!cargandoEstudiantes && !errorEstudiantes">{{ estudiantes.length }} en total</span>
    </div>

    <div class="alert error" *ngIf="errorEstudiantes">{{ errorEstudiantes }}</div>
    <p class="muted" *ngIf="cargandoEstudiantes">Cargando estudiantes…</p>

    <table class="tbl" *ngIf="!cargandoEstudiantes && !errorEstudiantes && estudiantes.length">
      <thead>
        <tr>
          <th>Estudiante</th>
          <th>Carrera</th>
          <th>Proceso</th>
          <th>Proyecto</th>
          <th>Avance</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let estudiante of estudiantes">
          <td class="student-name">{{ estudiante.nombre }}</td>
          <td>{{ estudiante.carrera }}</td>
          <td><span class="process-type">{{ estudiante.proceso }}</span></td>
          <td class="proyecto">{{ estudiante.proyecto }}</td>
          <td>
            <ng-container *ngIf="estudiante.avance !== null; else sinAvance">
              <div class="progress-container">
                <div class="prog">
                  <div class="bar" [style.width.%]="estudiante.avance"></div>
                </div>
                <span class="progress-text">{{ estudiante.avance }}%</span>
              </div>
            </ng-container>
            <ng-template #sinAvance><span class="muted">Sin entregas</span></ng-template>
          </td>
        </tr>
      </tbody>
    </table>

    <div class="empty-box" *ngIf="!cargandoEstudiantes && !errorEstudiantes && !estudiantes.length">
      No hay estudiantes asignados.
    </div>
  </div>
</div>

<div class="card solicitudes-card">
  <div class="card-header">
    <div class="card-title">
      <h3>Solicitudes de reunión</h3>
      <p class="muted">Revisa las solicitudes de tus alumnos y agenda directamente</p>
    </div>
    <div class="acciones-header">
      <span class="chip alerta" *ngIf="hayPendientes">
        {{ solicitudesPendientes.length }} pendiente{{ solicitudesPendientes.length === 1 ? '' : 's' }}
      </span>
      <button type="button" class="btn sm toggle" (click)="togglePendientes()">
        {{ mostrarPendientes ? 'Ocultar solicitudes' : 'Revisar solicitudes' }}
      </button>
    </div>
  </div>

  <div class="alert success" *ngIf="solicitudesMensaje">{{ solicitudesMensaje }}</div>
  <div class="alert error" *ngIf="solicitudesError">{{ solicitudesError }}</div>

  <p class="muted" *ngIf="solicitudesCargando">Cargando solicitudes…</p>
  <p class="muted" *ngIf="!solicitudesCargando && !solicitudes.length">No hay solicitudes registradas.</p>

  <div class="alert info" *ngIf="mostrarPendientes && !solicitudesPendientes.length && !solicitudesCargando">
    No hay solicitudes pendientes por revisar.
  </div>

  <ng-container *ngIf="mostrarPendientes">
    <div class="solicitud" *ngFor="let solicitud of solicitudesPendientes">
      <header>
        <div>
          <h4>{{ solicitud.proyectoNombre || 'Proyecto sin nombre' }}</h4>
          <div class="muted" *ngIf="solicitud.alumno?.nombre">Alumno: {{ solicitud.alumno?.nombre }}</div>
          <small class="muted">Enviada el {{ fechaHora(solicitud.creadoEn) }}</small>
        </div>
        <span
          class="estado"
          [class.pendiente]="solicitud.estado === 'pendiente'"
          [class.aprobada]="solicitud.estado === 'aprobada'"
          [class.rechazada]="solicitud.estado === 'rechazada'"
        >
          {{ estadoSolicitudLabel(solicitud.estado) }}
        </span>
      </header>

      <p class="motivo">{{ solicitud.motivo }}</p>
      <p class="muted" *ngIf="solicitud.disponibilidadSugerida">
        Disponibilidad sugerida: <strong>{{ solicitud.disponibilidadSugerida }}</strong>
      </p>

      <div class="acciones" *ngIf="solicitud.estado === 'pendiente'">
        <button class="btn-edit" type="button" (click)="abrirAprobacion(solicitud)" [disabled]="procesandoSolicitud">
          Aprobar y agendar
        </button>
        <button class="btn-cancel" type="button" (click)="abrirRechazo(solicitud)" [disabled]="procesandoSolicitud">
          Rechazar
        </button>
      </div>

      <form
        class="panel-form"
        *ngIf="seleccionada?.id === solicitud.id && modo === 'aprobar'"
        [formGroup]="aprobarForm"
        (ngSubmit)="confirmarAprobacion()"
      >
        <h4>Agendar reunión</h4>
        <p class="muted" *ngIf="fechaHoraFija">
          Fecha y hora solicitadas por el alumno. Solo selecciona la duración y agrega comentarios.
        </p>
        <div class="horario-fijo" *ngIf="fechaHoraFija">
          <div>
            <span class="etiqueta">Fecha</span>
            <strong>{{ aprobarForm.controls.fecha.value | date: 'dd/MM/yyyy' }}</strong>
          </div>
          <div>
            <span class="etiqueta">Horario</span>
            <strong>{{ aprobarForm.controls.horaInicio.value }} - {{ aprobarForm.controls.horaTermino.value }}</strong>
          </div>
        </div>
        <div class="grid form-grid">
          <label>
            Fecha
            <input
              type="date"
              formControlName="fecha"
              [attr.readonly]="fechaHoraFija ? '' : null"
              [disabled]="fechaHoraFija"
              [class.readonly]="fechaHoraFija"
            />
          </label>
          <label>
            Hora inicio
            <input
              type="time"
              formControlName="horaInicio"
              [attr.readonly]="fechaHoraFija ? '' : null"
              [disabled]="fechaHoraFija"
              [class.readonly]="fechaHoraFija"
            />
          </label>
          <label>
            Duración
            <select formControlName="duracion">
              <option *ngFor="let dur of duracionesDisponibles" [ngValue]="dur">
                {{ dur }} minutos
              </option>
            </select>
          </label>
          <label>
            Hora término
            <input type="time" formControlName="horaTermino" readonly />
          </label>
          <label>
            Modalidad
            <select formControlName="modalidad">
              <option value="presencial">Presencial</option>
              <option value="online">Online</option>
            </select>
          </label>
        </div>
        <label class="block">
          Comentario (opcional)
          <textarea rows="3" formControlName="comentario" placeholder="Instrucciones para el estudiante"></textarea>
        </label>
        <div class="acciones">
          <button class="btn-edit" type="submit" [disabled]="procesandoSolicitud">
            {{ procesandoSolicitud ? 'Guardando…' : 'Confirmar reunión' }}
          </button>
          <button class="btn-session" type="button" (click)="cancelarAccion()">Cancelar</button>
        </div>
      </form>

      <form
        class="panel-form"
        *ngIf="seleccionada?.id === solicitud.id && modo === 'rechazar'"
        [formGroup]="rechazoForm"
        (ngSubmit)="confirmarRechazo()"
      >
        <h4>Rechazar solicitud</h4>
        <label class="block">
          Comentario (opcional)
          <textarea rows="3" formControlName="comentario" placeholder="Explica al estudiante el motivo"></textarea>
        </label>
        <div class="acciones">
          <button class="btn-cancel" type="submit" [disabled]="procesandoSolicitud">
            {{ procesandoSolicitud ? 'Guardando…' : 'Confirmar rechazo' }}
          </button>
          <button class="btn-session" type="button" (click)="cancelarAccion()">Cancelar</button>
        </div>
      </form>
    </div>
  </ng-container>

  <div class="historial" *ngIf="solicitudesResueltas.length">
    <div class="historial-header">
      <h4>Historial de solicitudes</h4>
      <button type="button" class="link-button" (click)="toggleHistorial()">
        {{ mostrarHistorial ? 'Ocultar historial' : 'Ver historial' }}
      </button>
    </div>
    <ul class="historial-lista" *ngIf="mostrarHistorial">
      <li *ngFor="let solicitud of historialPaginado">
        <div>
          <strong>{{ solicitud.proyectoNombre || 'Proyecto sin nombre' }}</strong>
          <div class="muted" *ngIf="solicitud.alumno?.nombre">Alumno: {{ solicitud.alumno?.nombre }}</div>
          <p class="muted">Actualizada el {{ fechaHora(solicitud.actualizadoEn) }}</p>
        </div>
        <span class="estado" [class.aprobada]="solicitud.estado === 'aprobada'" [class.rechazada]="solicitud.estado === 'rechazada'">
          {{ estadoSolicitudLabel(solicitud.estado) }}
        </span>
      </li>
    </ul>
    <div class="historial-paginacion" *ngIf="mostrarHistorial && historialTotalPaginas > 1">
      <button class="link-button" type="button" (click)="paginaHistorialAnterior()" [disabled]="historialPagina === 1">
        Anterior
      </button>
      <span class="muted">Página {{ historialPagina }} de {{ historialTotalPaginas }}</span>
      <button
        class="link-button"
        type="button"
        (click)="paginaHistorialSiguiente()"
        [disabled]="historialPagina === historialTotalPaginas"
      >
        Siguiente
      </button>
    </div>
  </div>
</div>

<section class="card solicitudes-card entregas-panel">
  <div class="card-header">
    <div class="card-title">
      <h3>Entregas recibidas</h3>
      <p class="muted">Revisa los archivos enviados por tus grupos y marca sus revisiones.</p>
    </div>
    <div class="acciones-header">
      <button type="button" class="btn sm" (click)="exportarNotasCsv()" [disabled]="!entregasRevisadas.length">
        Exportar notas CSV
      </button>
    </div>
  </div>

  <div class="alert error" *ngIf="entregasError">{{ entregasError }}</div>
  <p class="muted" *ngIf="entregasCargando && !entregasError">Cargando entregas…</p>

  <ng-container *ngIf="!entregasCargando && !entregasError">
    <ng-container *ngIf="entregasPorGrupo.length; else sinEntregasDash">
      <div class="entregas-grupos">
        <article
          class="grupo-entrega-card"
          *ngFor="let grupo of entregasPorGrupo"
          [class.cerrado]="!grupo.abierto"
        >
          <button type="button" class="grupo-toggle" (click)="seleccionarGrupoEntregas(grupo.nombre)">
            <div class="grupo-titulo">
              <h4>{{ grupo.nombre }}</h4>
              <small *ngIf="grupo.abierto">{{ grupo.pendientes.length + grupo.revisadas.length }} entregas</small>
            </div>
            <div class="grupo-resumen" *ngIf="grupo.abierto">
              <span class="chip warn">{{ grupo.pendientes.length }} pendientes</span>
              <span class="chip ok">{{ grupo.revisadas.length }} revisadas</span>
            </div>
            <span class="caret" [class.open]="grupo.abierto">▼</span>
          </button>

          <div class="grupo-detalle" *ngIf="grupo.abierto">
            <div class="entregas-grid detalle-grid">
              <div class="entregas-col">
                <div class="col-header">
                  <h5>Pendientes</h5>
                  <span class="pill" [class.empty]="!grupo.pendientes.length">{{ grupo.pendientes.length }}</span>
                </div>
                <ng-container *ngIf="grupo.pendientes.length; else sinPendientesDash">
                  <article class="entrega-card pendiente" *ngFor="let entrega of grupo.pendientes">
                    <header>
                      <div>
                        <h5>
                          <span class="tag info" *ngIf="entrega.esBitacora">
                            Bitácora {{ entrega.bitacoraIndice || '-' }}
                          </span>
                          {{ entrega.evaluacionTitulo }}
                        </h5>
                        <span class="tag warn">Por revisar</span>
                      </div>
                      <small>{{ entrega.fecha | date:'d MMM y, HH:mm' }}</small>
                    </header>
                    <ul class="info">
                      <li>
                        <strong>Alumno:</strong> {{ entrega.alumnoNombre }}
                        <span class="muted" *ngIf="entrega.alumnoCorreo">({{ entrega.alumnoCorreo }})</span>
                      </li>
                      <li><strong>Archivo:</strong> {{ entrega.archivoNombre }}</li>
                      <li *ngIf="entrega.comentario"><strong>Comentario:</strong> {{ entrega.comentario }}</li>
                    </ul>
                    <button class="btn sm" (click)="descargarEntrega(entrega)" [disabled]="!entrega.archivoUrl">
                      Revisar
                    </button>
                  </article>
                </ng-container>
              </div>

              <div class="entregas-col">
                <div class="col-header">
                  <h5>Revisadas</h5>
                  <span class="pill" [class.empty]="!grupo.revisadas.length">{{ grupo.revisadas.length }}</span>
                </div>
                <ng-container *ngIf="grupo.revisadas.length; else sinRevisadasDash">
                  <article class="entrega-card revisada" *ngFor="let entrega of grupo.revisadas">
                    <header>
                      <div>
                        <h5>
                          <span class="tag info" *ngIf="entrega.esBitacora">
                            Bitácora {{ entrega.bitacoraIndice || '-' }}
                          </span>
                          {{ entrega.evaluacionTitulo }}
                        </h5>
                        <span class="tag ok">Revisada</span>
                      </div>
                      <small>{{ entrega.fecha | date:'d MMM y, HH:mm' }}</small>
                    </header>
                    <ul class="info">
                      <li>
                        <strong>Alumno:</strong> {{ entrega.alumnoNombre }}
                        <span class="muted" *ngIf="entrega.alumnoCorreo">({{ entrega.alumnoCorreo }})</span>
                      </li>
                      <li><strong>Archivo:</strong> {{ entrega.archivoNombre }}</li>
                      <li *ngIf="entrega.nota != null"><strong>Nota:</strong> {{ entrega.nota }}</li>
                      <li *ngIf="entrega.comentario"><strong>Comentario:</strong> {{ entrega.comentario }}</li>
                    </ul>
                    <button class="btn sm" (click)="descargarEntrega(entrega)" [disabled]="!entrega.archivoUrl">
                      Ver archivo
                    </button>
                  </article>
                </ng-container>
              </div>
            </div>

            <ng-template #sinPendientesDash>
              <p class="muted">No tienes entregas pendientes de revisión.</p>
            </ng-template>
            <ng-template #sinRevisadasDash>
              <p class="muted">Aún no hay entregas revisadas.</p>
            </ng-template>
          </div>
        </article>
      </div>
    </ng-container>

    <ng-template #sinEntregasDash>
      <p class="muted">Aún no hay entregas registradas para tus grupos.</p>
    </ng-template>
  </ng-container>
</section>