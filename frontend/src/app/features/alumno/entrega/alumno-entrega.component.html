<h2 class="ttl">{{ titulo }}</h2>

<!-- Bit√°coras programadas -->
<section class="card" *ngIf="bitacoras().length">
  <div class="bitacoras-head">
    <div>
      <h3>Bit√°coras</h3>
      <p class="muted">Seguimiento semanal solicitado por tu docente.</p>
    </div>
    <span class="chip warn">Pendientes</span>
  </div>

  <div class="bitacoras-grid">
    <article class="item" *ngFor="let b of bitacoras()">
      <div class="top">
        <b class="title">{{ b.titulo }}</b>
        <span class="chip warn">{{ b.estado }}</span>
      </div>
      <p class="desc">{{ b.comentario || 'Sigue el progreso semanal de tu trabajo.' }}</p>
      <div class="meta">
        <span>Evaluaci√≥n: {{ b.evaluacionTitulo }}</span>
        <span>Fecha l√≠mite: {{ b.fechaLimite | date:'d MMM y' }}</span>
      </div>
    </article>
  </div>
</section>

<!-- Evaluaciones -->
<section class="card">
  <h3>Evaluaciones</h3>

  <div class="error" *ngIf="loadError() as msg">{{ msg }}</div>
  <p class="muted" *ngIf="cargando()">Cargando evaluaciones‚Ä¶</p>

  <div class="split" *ngIf="!cargando()">
    <!-- Pendientes -->
    <div>
      <h4 class="sec">Pendientes</h4>
      <div class="grid" *ngIf="pendientes().length; else noPend">
        <article class="item" *ngFor="let e of pendientes()" (click)="seleccionar(e)">
          <div class="top">
            <b class="title">{{ e.titulo }}</b>
            <span [ngClass]="estadoClase(e.estado)">{{ e.estado }}</span>
          </div>
          <p class="desc" *ngIf="e.descripcion">{{ e.descripcion }}</p>
          <div class="meta">
            <ng-container *ngIf="e.fechaLimite; else noFechaPend">
              <span>Fecha l√≠mite: {{ e.fechaLimite | date:'d MMM y, HH:mm' }}</span>
            </ng-container>
            <ng-template #noFechaPend>
              <span>Fecha l√≠mite no asignada</span>
            </ng-template>
          </div>
        </article>
      </div>
      <ng-template #noPend>
        <p class="muted">No tienes evaluaciones pendientes.</p>
      </ng-template>
    </div>

    <!-- Completadas -->
    <div>
      <h4 class="sec">Completadas</h4>
      <div class="grid" *ngIf="completadas().length; else noComp">
        <article class="item" *ngFor="let e of completadas()" (click)="seleccionar(e)">
          <div class="top">
            <b class="title">{{ e.titulo }}</b>
            <span [ngClass]="estadoClase(e.estado)">{{ e.estado }}</span>
          </div>
          <p class="desc" *ngIf="e.descripcion">{{ e.descripcion }}</p>
          <div class="meta">
            <ng-container *ngIf="e.fechaLimite; else noFechaComp">
              <span>Fecha l√≠mite: {{ e.fechaLimite | date:'d MMM y, HH:mm' }}</span>
            </ng-container>
            <ng-template #noFechaComp>
              <span>Fecha l√≠mite no asignada</span>
            </ng-template>
            <!-- usar ?. porque ultimaEntrega puede no venir -->
            <span *ngIf="e.ultimaEntrega?.nota != null">
              ‚Ä¢ Nota: <b>{{ e.ultimaEntrega?.nota }}</b>
            </span>
          </div>
        </article>
      </div>
      <ng-template #noComp>
        <p class="muted">A√∫n no tienes entregas registradas.</p>
      </ng-template>
    </div>
  </div>
</section>

<!-- Panel detalle -->
<section class="card" *ngIf="seleccionada() as ev">
  <div class="detail-head">
    <h3>Detalle ‚Äî {{ ev.titulo }}</h3>
    <button class="link" (click)="limpiarSeleccion()">‚úï Cerrar</button>
  </div>

  <!-- Instrucciones din√°micas por tipo -->
  <div class="instrucciones detail">
    <div class="ins-head">
      <b>Instrucciones</b>
      <span class="tag">Para: {{ ev.tipo | titlecase }}</span>
    </div>
    <ul class="ins-list">
      <li *ngFor="let i of getInstrucciones(ev)">{{ i }}</li>
    </ul>
  </div>

  <p class="muted" *ngIf="ev.descripcion">{{ ev.descripcion }}</p>

  <div class="info-row">
    <span class="chip" [ngClass]="estadoClase(ev.estado)">{{ ev.estado }}</span>
    <ng-container *ngIf="ev.fechaLimite; else noFechaDetalle">
      <span class="muted">Fecha l√≠mite: {{ ev.fechaLimite | date:'d MMM y, HH:mm' }}</span>
    </ng-container>
  </div>
  <ng-template #noFechaDetalle>
    <span class="muted">Fecha l√≠mite no asignada</span>
  </ng-template>

  <div class="docente-detail">
    <div class="docente-head">
      <b>Detalles del docente</b>
      <span class="muted">Informaci√≥n que acompa√±a a la evaluaci√≥n</span>
    </div>

    <div class="row">
      <div><b>Comentario:</b></div>
      <div>{{ ev.comentario || 'Sin comentarios adicionales.' }}</div>
    </div>

    <div class="row">
      <div><b>R√∫brica:</b></div>
      <div>
        <ng-container *ngIf="ev.rubricaUrl && ev.rubricaNombre; else sinRubrica">
          <a
            [href]="ev.rubricaUrl"
            target="_blank"
            rel="noopener noreferrer"
          >
            üìé {{ ev.rubricaNombre }}
          </a>
          <small class="muted" *ngIf="ev.rubricaTipo">({{ ev.rubricaTipo }})</small>
        </ng-container>
        <ng-template #sinRubrica>
          Sin r√∫brica adjunta.
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Si pendiente -> bot√≥n subir -->
  <div *ngIf="canUpload(); else vistaEntrega">
    <p class="muted">Esta evaluaci√≥n est√° pendiente. Debes subir tu archivo para completar la entrega.</p>
    <button class="btn primary" (click)="openUpload()">Subir archivo</button>
  </div>

  <!-- Entregada / Calificada -->
  <ng-template #vistaEntrega>
    <div *ngIf="ev.ultimaEntrega; else sinEntrega" class="entrega">
      <div class="row">
        <div><b>T√≠tulo:</b></div>
        <div>{{ ev.ultimaEntrega.titulo }}</div>
      </div>

      <div class="row" *ngIf="ev.ultimaEntrega.comentario">
        <div><b>Comentario:</b></div>
        <div>{{ ev.ultimaEntrega.comentario }}</div>
      </div>

      <div class="row">
        <div><b>Archivo:</b></div>
        <div>
          üìÑ
          <ng-container *ngIf="ev.ultimaEntrega.archivoUrl; else archivoSinLink">
            <a
              [href]="ev.ultimaEntrega.archivoUrl"
              target="_blank"
              rel="noopener noreferrer"
            >
              {{ ev.ultimaEntrega.archivoNombre }}
            </a>
          </ng-container>
          <ng-template #archivoSinLink>
            {{ ev.ultimaEntrega.archivoNombre }}
          </ng-template>
          <small class="muted">({{ ev.ultimaEntrega.archivoTipo }})</small>
        </div>
      </div>

      <div class="row" *ngIf="ev.ultimaEntrega.rubricaUrl">
        <div><b>R√∫brica corregida:</b></div>
        <div>
          üìé
          <a
            [href]="ev.ultimaEntrega.rubricaUrl"
            target="_blank"
            rel="noopener noreferrer"
          >
            {{ ev.ultimaEntrega.rubricaNombre || 'R√∫brica' }}
          </a>
          <small class="muted" *ngIf="ev.ultimaEntrega.rubricaTipo">({{ ev.ultimaEntrega.rubricaTipo }})</small>
        </div>
      </div>

      <div class="row" *ngIf="ev.ultimaEntrega.informeUrl">
        <div><b>Informe corregido:</b></div>
        <div>
          üìù
          <a
            [href]="ev.ultimaEntrega.informeUrl"
            target="_blank"
            rel="noopener noreferrer"
          >
            {{ ev.ultimaEntrega.informeNombre || 'Informe con anotaciones' }}
          </a>
          <small class="muted" *ngIf="ev.ultimaEntrega.informeTipo">({{ ev.ultimaEntrega.informeTipo }})</small>
        </div>
      </div>

      <div class="row">
        <div><b>Fecha env√≠o:</b></div>
        <div>{{ ev.ultimaEntrega.fecha | date:'d MMM y, HH:mm' }}</div>
      </div>

      <div class="row" *ngIf="ev.ultimaEntrega.nota != null">
        <div><b>Nota:</b></div>
        <div><span class="nota">{{ ev.ultimaEntrega.nota }}</span></div>
      </div>
    </div>

    <ng-template #sinEntrega>
      <p class="muted">A√∫n no existe registro de entrega.</p>
    </ng-template>
  </ng-template>
</section>

<!-- Modal subir archivo -->
<div class="overlay" *ngIf="showUpload()">
  <div class="modal">
    <header>
      <h3>Subir archivo</h3>
      <button class="x" (click)="closeUpload()">‚úï</button>
    </header>

    <form class="form" (ngSubmit)="submitUpload()">
      <label class="field">
        <span class="lbl">T√≠tulo del env√≠o</span>
        <input type="text" [(ngModel)]="upload.titulo" name="titulo" placeholder="Ej: Informe de avance #2"/>
      </label>

      <label class="field">
        <span class="lbl">Comentario (opcional)</span>
        <textarea rows="4" [(ngModel)]="upload.comentario" name="comentario" placeholder="Notas para el docente..."></textarea>
      </label>

      <div class="drop" [class.dragging]="isDragging()"
           (drop)="onDrop($event)" (dragover)="onDragOver($event)" (dragleave)="onDragLeave()">
        <div class="icon">üì§</div>
        <div><b>Arrastra y suelta</b> tu archivo aqu√≠</div>
        <div class="muted">o</div>
        <label class="picker">
          <input type="file" (change)="onFilePick($event)"/>
          Seleccionar archivo
        </label>
        <div class="small">Formatos: PDF, DOC/DOCX, PPT/PPTX, ZIP (m√°x. {{ maxMB }} MB)</div>
      </div>

      <div class="file-info" *ngIf="archivoInfo() as f">
        <div class="name">üìÑ {{ f.name }}</div>
        <div class="meta">{{ f.type }} ‚Äî {{ f.sizeMB }} MB</div>
      </div>

      <div class="error" *ngIf="errorMsg()">{{ errorMsg() }}</div>

      <div class="progress" *ngIf="sending()">
        <div class="bar" [style.width.%]="progress()"></div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn" (click)="closeUpload()" [disabled]="sending()">Cancelar</button>
        <button type="submit" class="btn primary" [disabled]="sending()">Subir archivo</button>
      </div>
    </form>
  </div>
</div>