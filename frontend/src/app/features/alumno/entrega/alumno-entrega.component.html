<h2 class="ttl">{{ titulo }}</h2>

<!-- Evaluaciones -->
<section class="card">
  <h3>Evaluaciones</h3>

  <div class="error" *ngIf="loadError() as msg">{{ msg }}</div>
  <p class="muted" *ngIf="cargando()">Cargando evaluacionesâ€¦</p>

  <div class="split" *ngIf="!cargando()">
    <!-- Pendientes -->
    <div>
      <h4 class="sec">Pendientes</h4>
      <div class="grid" *ngIf="pendientes().length; else noPend">
        <article class="item" *ngFor="let e of pendientes()" (click)="seleccionar(e)">
          <div class="top">
            <b class="title">{{ e.titulo }}</b>
            <span [ngClass]="estadoClase(e.estado)">{{ e.estado }}</span>
          </div>
          <p class="desc" *ngIf="e.descripcion">{{ e.descripcion }}</p>
          <div class="meta">
            <span>Fecha lÃ­mite: {{ e.fechaLimite | date:'d MMM y, HH:mm' }}</span>
          </div>
        </article>
      </div>
      <ng-template #noPend>
        <p class="muted">No tienes evaluaciones pendientes.</p>
      </ng-template>
    </div>

    <!-- Completadas -->
    <div>
      <h4 class="sec">Completadas</h4>
      <div class="grid" *ngIf="completadas().length; else noComp">
        <article class="item" *ngFor="let e of completadas()" (click)="seleccionar(e)">
          <div class="top">
            <b class="title">{{ e.titulo }}</b>
            <span [ngClass]="estadoClase(e.estado)">{{ e.estado }}</span>
          </div>
          <p class="desc" *ngIf="e.descripcion">{{ e.descripcion }}</p>
          <div class="meta">
            <span>Fecha lÃ­mite: {{ e.fechaLimite | date:'d MMM y, HH:mm' }}</span>
            <!-- usar ?. porque ultimaEntrega puede no venir -->
            <span *ngIf="e.ultimaEntrega?.nota != null">
              â€¢ Nota: <b>{{ e.ultimaEntrega?.nota }}</b>
            </span>
          </div>
        </article>
      </div>
      <ng-template #noComp>
        <p class="muted">AÃºn no tienes entregas registradas.</p>
      </ng-template>
    </div>
  </div>
</section>

<!-- Panel detalle -->
<section class="card" *ngIf="seleccionada() as ev">
  <div class="detail-head">
    <h3>Detalle â€” {{ ev.titulo }}</h3>
    <button class="link" (click)="limpiarSeleccion()">âœ• Cerrar</button>
  </div>

  <!-- Instrucciones dinÃ¡micas por tipo -->
  <div class="instrucciones detail">
    <div class="ins-head">
      <b>Instrucciones</b>
      <span class="tag">Para: {{ ev.tipo | titlecase }}</span>
    </div>
    <ul class="ins-list">
      <li *ngFor="let i of getInstrucciones(ev)">{{ i }}</li>
    </ul>
  </div>

  <p class="muted" *ngIf="ev.descripcion">{{ ev.descripcion }}</p>

  <div class="info-row">
    <span class="chip" [ngClass]="estadoClase(ev.estado)">{{ ev.estado }}</span>
    <span class="muted">Fecha lÃ­mite: {{ ev.fechaLimite | date:'d MMM y, HH:mm' }}</span>
  </div>

  <!-- Si pendiente -> botÃ³n subir -->
  <div *ngIf="canUpload(); else vistaEntrega">
    <p class="muted">Esta evaluaciÃ³n estÃ¡ pendiente. Debes subir tu archivo para completar la entrega.</p>
    <button class="btn primary" (click)="openUpload()">Subir archivo</button>
  </div>

  <!-- Entregada / Calificada -->
  <ng-template #vistaEntrega>
    <div *ngIf="ev.ultimaEntrega; else sinEntrega" class="entrega">
      <div class="row">
        <div><b>TÃ­tulo:</b></div>
        <div>{{ ev.ultimaEntrega.titulo }}</div>
      </div>

      <div class="row" *ngIf="ev.ultimaEntrega.comentario">
        <div><b>Comentario:</b></div>
        <div>{{ ev.ultimaEntrega.comentario }}</div>
      </div>

      <div class="row">
        <div><b>Archivo:</b></div>
        <div>
          ðŸ“„
          <ng-container *ngIf="ev.ultimaEntrega.archivoUrl; else archivoSinLink">
            <a
              [href]="ev.ultimaEntrega.archivoUrl"
              target="_blank"
              rel="noopener noreferrer"
            >
              {{ ev.ultimaEntrega.archivoNombre }}
            </a>
          </ng-container>
          <ng-template #archivoSinLink>
            {{ ev.ultimaEntrega.archivoNombre }}
          </ng-template>
          <small class="muted">({{ ev.ultimaEntrega.archivoTipo }})</small>
        </div>
      </div>

      <div class="row">
        <div><b>Fecha envÃ­o:</b></div>
        <div>{{ ev.ultimaEntrega.fecha | date:'d MMM y, HH:mm' }}</div>
      </div>

      <div class="row" *ngIf="ev.ultimaEntrega.nota != null">
        <div><b>Nota:</b></div>
        <div><span class="nota">{{ ev.ultimaEntrega.nota }}</span></div>
      </div>
    </div>

    <ng-template #sinEntrega>
      <p class="muted">AÃºn no existe registro de entrega.</p>
    </ng-template>
  </ng-template>
</section>

<!-- Modal subir archivo -->
<div class="overlay" *ngIf="showUpload()">
  <div class="modal">
    <header>
      <h3>Subir archivo</h3>
      <button class="x" (click)="closeUpload()">âœ•</button>
    </header>

    <form class="form" (ngSubmit)="submitUpload()">
      <label class="field">
        <span class="lbl">TÃ­tulo del envÃ­o</span>
        <input type="text" [(ngModel)]="upload.titulo" name="titulo" placeholder="Ej: Informe de avance #2"/>
      </label>

      <label class="field">
        <span class="lbl">Comentario (opcional)</span>
        <textarea rows="4" [(ngModel)]="upload.comentario" name="comentario" placeholder="Notas para el docente..."></textarea>
      </label>

      <div class="drop" [class.dragging]="isDragging()"
           (drop)="onDrop($event)" (dragover)="onDragOver($event)" (dragleave)="onDragLeave()">
        <div class="icon">ðŸ“¤</div>
        <div><b>Arrastra y suelta</b> tu archivo aquÃ­</div>
        <div class="muted">o</div>
        <label class="picker">
          <input type="file" (change)="onFilePick($event)"/>
          Seleccionar archivo
        </label>
        <div class="small">Formatos: PDF, DOC/DOCX, PPT/PPTX, ZIP (mÃ¡x. {{ maxMB }} MB)</div>
      </div>

      <div class="file-info" *ngIf="archivoInfo() as f">
        <div class="name">ðŸ“„ {{ f.name }}</div>
        <div class="meta">{{ f.type }} â€” {{ f.sizeMB }} MB</div>
      </div>

      <div class="error" *ngIf="errorMsg()">{{ errorMsg() }}</div>

      <div class="progress" *ngIf="sending()">
        <div class="bar" [style.width.%]="progress()"></div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn" (click)="closeUpload()" [disabled]="sending()">Cancelar</button>
        <button type="submit" class="btn primary" [disabled]="sending()">Subir archivo</button>
      </div>
    </form>
  </div>
</div>
