<div class="card">
  <h2 class="ttl">Temas de Trabajo de TÃ­tulo</h2>

  <div class="tabs">
    <button [class.active]="tab() === 'temas'" (click)="tab.set('temas')">Temas disponibles</button>
    <button [class.active]="tab() === 'propuestas'" (click)="tab.set('propuestas')">Mis propuestas</button>
    <button class="btn primary sm" type="button" (click)="togglePostulacion(true)">
      + Postular / Proponer tema
    </button>
  </div>

  <ng-container [ngSwitch]="tab()">
    <ng-container *ngSwitchCase="'temas'">
      <p class="muted">Explora los temas disponibles para postular a tu trabajo de tÃ­tulo.</p>

      <ng-container *ngIf="temasCargando(); else temasContenido">
        <p class="muted" style="margin-top: 1rem">Cargando temas disponibles...</p>
      </ng-container>

      <ng-template #temasContenido>
        <div class="err" *ngIf="temasError(); else temasLista">{{ temasError() }}</div>
      </ng-template>

      <ng-template #sinTemas>
        <p class="muted" style="margin-top: 1rem">AÃºn no hay temas disponibles.</p>
      </ng-template>

      <ng-template #temasLista>
        <div class="alert success" *ngIf="reservaMensaje()">{{ reservaMensaje() }}</div>
        <div class="alert error" *ngIf="reservaError()">{{ reservaError() }}</div>

        <ul class="list topics" *ngIf="temas().length; else sinTemas">
          <li *ngFor="let tema of temas()">
            <div class="grupo-info">
              <div class="grupo-nombre">
                {{ tema.titulo }}
                <span class="badge">{{ tema.carrera }}</span>
              </div>
              <div class="grupo-alumnos">{{ tema.descripcion }}</div>
              <div class="tema-autor" *ngIf="tema.creadoPor as autor">
                <span class="tema-autor__icon" aria-hidden="true">ðŸ‘¤</span>
                <span *ngIf="autor.rol === 'alumno'; else autorDocente">
                  Propuesta creada por
                  <strong class="tema-autor__nombre">{{ autor.nombre }}</strong>
                  Â· {{ autor.rol | titlecase }}
                  <ng-container *ngIf="autor.carrera"> â€” {{ autor.carrera }}</ng-container>
                  <ng-container *ngIf="tema.docenteACargo as docente">
                    Â· Docente a cargo
                    <strong class="tema-autor__nombre">{{ docente.nombre }}</strong>
                  </ng-container>
                </span>
                <ng-template #autorDocente>
                  <span>
                    Profesor creador
                    <strong class="tema-autor__nombre">{{ autor.nombre }}</strong>
                    Â· {{ autor.rol | titlecase }}
                    <ng-container *ngIf="autor.carrera"> â€” {{ autor.carrera }}</ng-container>
                  </span>
                </ng-template>
              </div>
              <div class="tema-autor" *ngIf="!tema.creadoPor && tema.docenteACargo as docente">
                <span class="tema-autor__icon" aria-hidden="true">ðŸ‘¤</span>
                <span>
                  Docente a cargo
                  <strong class="tema-autor__nombre">{{ docente.nombre }}</strong>
                  Â· {{ docente.rol | titlecase }}
                  <ng-container *ngIf="docente.carrera"> â€” {{ docente.carrera }}</ng-container>
                </span>
              </div>
              <div class="chips meta">
                <span class="chip ghost">Cupos disp.: {{ tema.cuposDisponibles }} / {{ tema.cupos }}</span>
                <span class="chip success" *ngIf="tema.tieneCupoPropio">Tu cupo reservado</span>
              </div>
              <div class="chips requisitos" *ngIf="tema.requisitos?.length">
                <span class="chip" *ngFor="let req of tema.requisitos">{{ req }}</span>
              </div>
            </div>
            <div class="tema-actions">
              <button
                type="button"
                class="btn primary sm"
                [disabled]="!puedePedirTema(tema) || reservandoTemaId() === tema.id"
                (click)="abrirConfirmacionTema(tema)"
              >
                {{ etiquetaPedirTema(tema) }}
              </button>
              <button
                type="button"
                class="btn light sm"
                *ngIf="puedeMostrarGestionCupos(tema)"
                (click)="abrirGestionCupos(tema)"
              >
                Gestionar cupos
              </button>
            </div>
          </li>
        </ul>
      </ng-template>
    </ng-container>

    <ng-container *ngSwitchCase="'propuestas'">
      <section class="mis-propuestas">
        <p class="muted" *ngIf="propuestasCargando()">Actualizando el estado de tus propuestasâ€¦</p>
        <div class="err" *ngIf="!propuestasCargando() && propuestasError()">{{ propuestasError() }}</div>

        <ng-container *ngIf="!propuestasCargando() && !propuestasError()">
          <ng-container *ngIf="propuestaDestacada() as propuestaPrincipal">
            <div
              class="propuesta-highlight"
              [ngClass]="clasePropuestaDestacadaEstado(propuestaPrincipal.estado)"
            >
              <div class="highlight-head">
                <span class="chip" [ngClass]="chipClasePropuesta(propuestaPrincipal.estado)">
                  {{ etiquetaPropuestaDestacada(propuestaPrincipal) }}
                </span>
                <span class="chip ghost">Actualizada {{ propuestaPrincipal.updatedAt | date:'dd MMM yyyy' }}</span>
              </div>
              <h4>{{ propuestaPrincipal.titulo }}</h4>
              <p class="muted">{{ propuestaPrincipal.descripcion }}</p>
              <div class="chips">
                <span class="chip">Rama: {{ propuestaPrincipal.rama }}</span>
                <span class="chip ghost" *ngIf="propuestaPrincipal.docente">
                  Docente guÃ­a: {{ propuestaPrincipal.docente.nombre }}
                </span>
              </div>
              <p class="comentario" *ngIf="propuestaPrincipal.comentarioDecision">
                Comentario del docente:
                <span>{{ propuestaPrincipal.comentarioDecision }}</span>
              </p>
              <div class="acciones-propuesta" *ngIf="puedeAjustarPropuesta(propuestaPrincipal)">
                <p class="muted small">
                  El docente autorizÃ³ un mÃ¡ximo de {{ propuestaPrincipal.cuposMaximoAutorizado }} integrantes.
                </p>
                <button class="btn primary" type="button" (click)="abrirAjustePropuesta(propuestaPrincipal)">
                  Ajustar cupos
                </button>
              </div>
            </div>
          </ng-container>

          <div class="propuestas-historial" *ngIf="propuestasEnHistorial().length; else sinPropuestas">
            <h4>Historial de propuestas</h4>
            <ul class="list propuestas">
              <li *ngFor="let propuesta of propuestasEnHistorial()">
                <div class="grupo-info">
                  <div class="grupo-nombre">
                    {{ propuesta.titulo }}
                    <span class="badge propuesta" [ngClass]="estadoPropuestaClase(propuesta.estado)">
                      {{ estadoPropuestaTexto[propuesta.estado] }}
                    </span>
                  </div>
                  <div class="grupo-alumnos">{{ propuesta.objetivo }}</div>
                  <p class="comentario" *ngIf="propuesta.comentarioDecision">
                    Comentario: <span>{{ propuesta.comentarioDecision }}</span>
                  </p>
                  <div class="chips">
                    <span class="chip ghost">Actualizada {{ propuesta.updatedAt | date:'dd MMM yyyy' }}</span>
                    <span class="chip ghost" *ngIf="propuesta.docente">Docente: {{ propuesta.docente.nombre }}</span>
                  </div>
                  <div class="acciones-propuesta" *ngIf="puedeAjustarPropuesta(propuesta)">
                    <button class="btn primary sm" type="button" (click)="abrirAjustePropuesta(propuesta)">
                      Ajustar cupos
                    </button>
                    <span class="muted small">MÃ¡ximo {{ propuesta.cuposMaximoAutorizado }} integrantes.</span>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <ng-template #sinPropuestas>
            <p class="muted">AÃºn no envÃ­as propuestas personalizadas.</p>
          </ng-template>
        </ng-container>
      </section>
    </ng-container>
  </ng-container>
</div>

<div class="backdrop" *ngIf="showAjustePropuesta()" (click)="cerrarAjustePropuesta()"></div>
<div
  class="modal ajuste-modal"
  *ngIf="showAjustePropuesta() && propuestaParaAjuste() as propuestaAjuste"
  role="dialog"
  aria-modal="true"
>
  <div class="modal-head">
    <h4 class="ttl" style="margin: 0">Ajustar cupos del grupo</h4>
    <button class="icon" type="button" (click)="cerrarAjustePropuesta()" aria-label="Cerrar">âœ•</button>
  </div>

  <form class="grid ajuste-form" [formGroup]="ajusteForm" (ngSubmit)="guardarAjustePropuesta()" novalidate>
    <div class="field">
      <label for="ajusteCupos">Integrantes del grupo <span class="req">*</span></label>
      <input
        type="number"
        id="ajusteCupos"
        formControlName="cupos"
        min="1"
        (change)="ajustarCorreosAjustePorCupos()"
      />
      <div class="err" *ngIf="ajusteForm.get('cupos')?.touched && ajusteForm.get('cupos')?.hasError('required')">
        Debes indicar la cantidad de integrantes.
      </div>
      <div class="err" *ngIf="ajusteForm.get('cupos')?.touched && ajusteForm.get('cupos')?.hasError('min')">
        El grupo debe tener al menos 1 integrante.
      </div>
      <div class="err" *ngIf="ajusteForm.get('cupos')?.touched && ajusteForm.get('cupos')?.hasError('max')">
        Puedes solicitar hasta 6 integrantes.
      </div>
      <p class="muted small" *ngIf="propuestaAjuste.cuposMaximoAutorizado">
        MÃ¡ximo autorizado por el docente: {{ propuestaAjuste.cuposMaximoAutorizado }} integrantes.
      </p>
    </div>

    <div class="field full">
      <label>Correos de tus compaÃ±eros</label>
      <p class="muted small">
        Opcional: ingresa hasta {{ maxCorreosPermitidosAjuste() }} correos distintos.
      </p>
      <div formArrayName="correos" class="correos-list">
        <div class="correo-item" *ngFor="let ctrl of correosAjuste.controls; let i = index">
          <input type="email" [formControlName]="i" placeholder="correo@ejemplo.cl" />
          <button type="button" class="icon" (click)="removerCorreoAjuste(i)" aria-label="Eliminar correo">âœ•</button>
          <div class="err" *ngIf="correoAjusteTieneError(i, 'email')">Ingresa un correo vÃ¡lido.</div>
        </div>
      </div>
      <button
        type="button"
        class="btn light sm"
        (click)="agregarCorreoAjuste()"
        [disabled]="!puedeAgregarCorreoAjuste() || ajusteEnCurso()"
      >Agregar correo</button>
    </div>

    <div class="err full" *ngIf="ajusteError()">{{ ajusteError() }}</div>

    <div class="actions full">
      <button type="button" class="btn light" (click)="cerrarAjustePropuesta()" [disabled]="ajusteEnCurso()">Cancelar</button>
      <button type="submit" class="btn primary" [disabled]="ajusteEnCurso()">
        {{ ajusteEnCurso() ? 'Guardandoâ€¦' : 'Confirmar cupos' }}
      </button>
    </div>
  </form>
</div>

<div class="backdrop" *ngIf="temaSeleccionado()" (click)="cerrarConfirmacionTema()"></div>
<div class="modal confirm-modal" *ngIf="temaSeleccionado() as temaEnConfirmacion" role="dialog" aria-modal="true">
  <div class="modal-head">
    <h4 class="ttl" style="margin: 0">Confirmar reserva</h4>
    <button class="icon" (click)="cerrarConfirmacionTema()" aria-label="Cerrar">âœ•</button>
  </div>
  <div class="modal-body tema-confirmacion">
    <div class="chips meta">
      <span class="chip ghost">Cupos disponibles: {{ temaEnConfirmacion.cuposDisponibles }} / {{ temaEnConfirmacion.cupos }}</span>
      <span class="chip ghost">Carrera: {{ temaEnConfirmacion.carrera }}</span>
    </div>
    <div>
      <h5>{{ temaEnConfirmacion.titulo }}</h5>
      <p class="descripcion">{{ temaEnConfirmacion.descripcion }}</p>
    </div>
    <div class="tema-confirmacion__autor">
      <span aria-hidden="true">ðŸ‘¤</span>
      <span>
        Profesor responsable:
        <strong>{{ temaEnConfirmacion.docenteACargo?.nombre || temaEnConfirmacion.creadoPor?.nombre || 'Por asignar' }}</strong>
      </span>
    </div>
    <div class="tema-confirmacion__requisitos" *ngIf="temaEnConfirmacion.requisitos?.length; else sinRequisitos">
      <h6>Requisitos del tema</h6>
      <ul>
        <li *ngFor="let requisito of temaEnConfirmacion.requisitos">{{ requisito }}</li>
      </ul>
    </div>
    <ng-template #sinRequisitos>
      <p class="muted" style="margin: 0">Este tema no especifica requisitos adicionales.</p>
    </ng-template>
    <p>Â¿Deseas continuar con la reserva?</p>
  </div>
  <div class="actions">
    <button type="button" class="btn light" (click)="cerrarConfirmacionTema()">Cancelar</button>
    <button
      type="button"
      class="btn primary"
      [disabled]="reservandoTemaId() === temaEnConfirmacion.id"
      (click)="confirmarReservaTema()"
    >
      {{ reservandoTemaId() === temaEnConfirmacion.id ? 'Reservandoâ€¦' : 'Confirmar' }}
    </button>
  </div>
</div>

<div class="backdrop" *ngIf="temaParaCupos()" (click)="cerrarGestionCupos()"></div>
<div class="modal cupos-modal" *ngIf="temaParaCupos() as temaGestion" role="dialog" aria-modal="true">
  <div class="modal-head">
    <h4 class="ttl" style="margin: 0">Gestionar cupos</h4>
    <button class="icon" type="button" (click)="cerrarGestionCupos()" aria-label="Cerrar">âœ•</button>
  </div>
  <div class="modal-body">
    <p class="muted" style="margin-top: 0">
      Ingresa los correos electrÃ³nicos de tus compaÃ±eros para completar los cupos disponibles del tema.
    </p>
    <div class="chips meta">
      <span class="chip ghost">Cupos totales: {{ temaGestion.cupos }}</span>
      <span class="chip ghost">Integrantes registrados: {{ temaGestion.inscripcionesActivas.length }}</span>
    </div>

    <div class="alert success" *ngIf="gestionCuposMensaje()">{{ gestionCuposMensaje() }}</div>
    <div class="alert error" *ngIf="gestionCuposError()">{{ gestionCuposError() }}</div>

    <form [formGroup]="cuposForm" (ngSubmit)="guardarCompaneros()" class="grid cupos-grid" novalidate>
      <div formArrayName="correos" class="full correos-array">
        <div class="field full correo-field" *ngFor="let control of correosForm.controls; let i = index">
          <label [attr.for]="'correo-companero-' + i">Correo del compaÃ±ero {{ i + 1 }}</label>
          <div class="correo-input">
            <input
              type="email"
              [id]="'correo-companero-' + i"
              [formControlName]="i"
              placeholder="nombre@ejemplo.cl"
              [readonly]="guardandoCompaneros()"
            />
            <button
              type="button"
              class="btn light sm"
              (click)="removerCampoCorreo(i)"
              [disabled]="guardandoCompaneros() || correosForm.length <= 1"
            >
              Quitar
            </button>
          </div>
          <div class="err" *ngIf="correoControlTieneError(i, 'email')">Correo electrÃ³nico invÃ¡lido.</div>
        </div>
      </div>

      <div class="acciones-correos" *ngIf="puedeAgregarOtroCorreo(temaGestion)">
        <button type="button" class="btn light sm" (click)="agregarCampoCorreo()" [disabled]="guardandoCompaneros()">
          + Agregar correo
        </button>
      </div>

      <div class="field full">
        <h5 style="margin: 16px 0 8px">Integrantes registrados</h5>
        <div class="chips participantes" *ngIf="temaGestion.inscripcionesActivas.length; else sinIntegrantes">
          <span class="chip" *ngFor="let integrante of temaGestion.inscripcionesActivas">
            {{ integrante.nombre }}
            <span *ngIf="integrante.correo"> Â· {{ integrante.correo }}</span>
          </span>
        </div>
        <ng-template #sinIntegrantes>
          <p class="muted" style="margin: 0">AÃºn no hay compaÃ±eros registrados.</p>
        </ng-template>
      </div>

      <div class="actions full">
        <button type="button" class="btn light" (click)="cerrarGestionCupos()" [disabled]="guardandoCompaneros()">
          Cerrar
        </button>
        <button type="submit" class="btn primary" [disabled]="guardandoCompaneros()">
          {{ guardandoCompaneros() ? 'Guardandoâ€¦' : 'Guardar cambios' }}
        </button>
      </div>
    </form>
  </div>
</div>

<div class="backdrop" *ngIf="showPostulacion()" (click)="togglePostulacion(false)"></div>
<div class="modal" *ngIf="showPostulacion()" role="dialog" aria-modal="true">
  <div class="modal-head">
    <h4 class="ttl" style="margin: 0">Solicitud de Tema</h4>
    <button class="icon" (click)="togglePostulacion(false)" aria-label="Cerrar">âœ•</button>
  </div>

  <form [formGroup]="postulacionForm" (ngSubmit)="submitPostulacion()" class="grid" novalidate>
    <div class="muted" *ngIf="profesoresCargando()">Cargando docentes disponibles...</div>
    <div class="err" *ngIf="profesoresError()">{{ profesoresError() }}</div>
    <div class="muted" *ngIf="!profesoresCargando() && !profesoresError() && !profesores().length">
      Por ahora no hay docentes disponibles en el listado.
    </div>
    <div class="err" *ngIf="postulacionError()">{{ postulacionError() }}</div>

    <div class="field full">
      <label for="titulo">Nombre del tema <span class="req">*</span></label>
      <input id="titulo" type="text" formControlName="titulo" />
      <div class="err" *ngIf="hasError('titulo','required')">Obligatorio.</div>
      <div class="err" *ngIf="hasError('titulo','maxlength')">MÃ¡x. 160 caracteres.</div>
    </div>

    <div class="field full">
      <label for="objetivo">Objetivo <span class="req">*</span></label>
      <input id="objetivo" type="text" formControlName="objetivo" />
      <div class="err" *ngIf="hasError('objetivo','required')">Obligatorio.</div>
      <div class="err" *ngIf="hasError('objetivo','maxlength')">MÃ¡x. 300 caracteres.</div>
    </div>

    <div class="field full">
      <label for="descripcion">Breve descripciÃ³n <span class="req">*</span></label>
      <textarea id="descripcion" rows="5" formControlName="descripcion"></textarea>
      <div class="err" *ngIf="hasError('descripcion','required')">Obligatorio.</div>
      <div class="err" *ngIf="hasError('descripcion','maxlength')">MÃ¡x. 1200 caracteres.</div>
    </div>

    <div class="field">
      <label for="rama">Rama de la carrera <span class="req">*</span></label>
      <select id="rama" formControlName="rama">
        <option value="" disabled>Selecciona una rama</option>
        <option *ngFor="let r of ramas" [value]="r">{{ r }}</option>
      </select>
      <div class="err" *ngIf="hasError('rama','required')">Selecciona una rama.</div>
    </div>

    <div class="field">
      <label for="prof1">Profesor guÃ­a (Preferencia 1) <span class="req">*</span></label>
      <select id="prof1" formControlName="prof1">
        <option value="" disabled>Selecciona</option>
        <option *ngFor="let p of profesoresFiltrados()" [value]="p.id">{{ p.nombre }}</option>
      </select>
      <div class="err" *ngIf="hasError('prof1','required')">Selecciona una opciÃ³n.</div>
    </div>

    <div class="field">
      <label for="prof2">Profesor guÃ­a (Preferencia 2)</label>
      <select id="prof2" formControlName="prof2">
        <option value="">(Opcional)</option>
        <option *ngFor="let p of profesoresFiltrados()" [value]="p.id">{{ p.nombre }}</option>
      </select>
    </div>

    <div class="field">
      <label for="prof3">Profesor guÃ­a (Preferencia 3)</label>
      <select id="prof3" formControlName="prof3">
        <option value="">(Opcional)</option>
        <option *ngFor="let p of profesoresFiltrados()" [value]="p.id">{{ p.nombre }}</option>
      </select>
    </div>

    <div class="field">
      <label for="cupos">Cupos del grupo <span class="req">*</span></label>
      <input
        id="cupos"
        type="number"
        formControlName="cupos"
        min="1"
        max="6"
        (change)="ajustarCompanerosPorCupos()"
      />
      <div class="err" *ngIf="hasError('cupos','required')">Debes indicar la cantidad de cupos.</div>
      <div class="err" *ngIf="hasError('cupos','min')">El grupo debe tener al menos 1 integrante.</div>
      <div class="err" *ngIf="hasError('cupos','max')">Puedes solicitar hasta 6 cupos.</div>
    </div>

    <div class="field full">
      <label>Correos de compaÃ±eros</label>
      <p class="muted" style="margin: 0 0 8px">
        Opcional: agrega los correos de tus compaÃ±eros para completar los cupos del grupo.
      </p>
      <div class="correos-array">
        <div class="correo-input" *ngFor="let control of companerosPostulacion.controls; index as i">
          <input type="email" [formControl]="control" placeholder="compaÃ±ero@utem.cl" />
          <button type="button" class="btn ghost" (click)="removerCompaneroPostulacion(i)">Quitar</button>
          <div class="err" *ngIf="companeroControlTieneError(i,'email')">Ingresa un correo vÃ¡lido.</div>
        </div>
      </div>
      <div class="acciones-correos">
        <button
          type="button"
          class="btn ghost"
          (click)="agregarCompaneroPostulacion()"
          [disabled]="!puedeAgregarCompaneroPostulacion()"
        >
          Agregar compaÃ±ero
        </button>
      </div>
    </div>

    <div class="field full" *ngIf="profesoresDuplicados">
      <span class="err">Las preferencias no pueden repetir al mismo profesor.</span>
    </div>

    <div class="actions full">
      <button type="button" class="btn light" (click)="togglePostulacion(false)">Cancelar</button>
      <button type="submit" class="btn primary" [disabled]="enviandoPropuesta()">
        {{ enviandoPropuesta() ? 'Enviandoâ€¦' : 'Enviar postulaciÃ³n' }}
      </button>
    </div>
  </form>
</div>