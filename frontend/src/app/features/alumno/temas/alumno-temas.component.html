<div class="card">
  <h2 class="ttl">Temas de Trabajo de T√≠tulo</h2>

  <div class="tabs">
    <button [class.active]="tab() === 'temas'" (click)="tab.set('temas')">Temas disponibles</button>
    <button [class.active]="tab() === 'propuestas'" (click)="tab.set('propuestas')">Mis propuestas</button>
    <button
      class="btn primary sm"
      type="button"
      (click)="togglePostulacion(true)"
      [disabled]="tieneTemaAsignado()"
    >
      + Postular / Proponer tema
    </button>
  </div>

  <ng-container [ngSwitch]="tab()">
    <ng-container *ngSwitchCase="'temas'">
      <p class="muted">Explora los temas disponibles para postular a tu trabajo de t√≠tulo.</p>

      <div class="alert warning" *ngIf="tieneTemaAsignado()">
        Ya cuentas con un tema inscrito. No puedes inscribir ni solicitar un nuevo tema.
      </div>


      <ng-container *ngIf="temasCargando(); else temasContenido">
        <p class="muted" style="margin-top: 1rem">Cargando temas disponibles...</p>
      </ng-container>

      <ng-template #temasContenido>
        <div class="err" *ngIf="temasError(); else temasLista">{{ temasError() }}</div>
      </ng-template>

      <ng-template #sinTemas>
        <p class="muted" style="margin-top: 1rem">
          {{ filtroProfesor() ? 'No hay temas que coincidan con tu b√∫squeda.' : 'A√∫n no hay temas disponibles.' }}
        </p>
      </ng-template>

      <ng-template #temasLista>
        <div class="alert success" *ngIf="reservaMensaje()">{{ reservaMensaje() }}</div>
        <div class="alert error" *ngIf="reservaError()">{{ reservaError() }}</div>

        <!-- Filtro por profesor -->
        <div class="filtros-container" *ngIf="temas().length">
          <div class="filtro-grupo">
            <label for="filtroProfesor" class="filtro-label">Filtrar por docente:</label>
            <div class="filtro-input-group">
              <select 
                id="filtroProfesor" 
                class="filtro-select"
                [value]="filtroProfesor()"
                (change)="aplicarFiltroProfesor($any($event.target).value)"
              >
                <option value="">Todos los docentes</option>
                <option *ngFor="let profesor of profesoresUnicos()" [value]="profesor">
                  {{ profesor }}
                </option>
              </select>
              <button 
                type="button" 
                class="btn light sm"
                *ngIf="filtroProfesor()"
                (click)="limpiarFiltro()"
              >
                Limpiar filtro
              </button>
            </div>
          </div>
          <div class="resultados-info" *ngIf="temasDisponiblesFiltrados().length > 0">
            <span class="chip ghost">{{ temasDisponiblesFiltrados().length }} tema(s) encontrado(s)</span>
          </div>
        </div>

        <ul class="list topics" *ngIf="temasPaginados().length; else sinTemas">
          <li *ngFor="let tema of temasPaginados()">
            <div class="grupo-info">
              <!-- T√≠tulo + Carrera -->
              <div class="grupo-nombre">
                {{ tema.titulo }}
                <span class="badge">{{ tema.carrera }}</span>
                <span class="chip success" *ngIf="tema.tieneCupoPropio">Tu cupo reservado</span>
              </div>
              
              <!-- Autor del tema -->
              <div class="tema-autor" *ngIf="tema.creadoPor as autor">
                <span class="tema-autor__icon" aria-hidden="true">üë§</span>
                <span *ngIf="autor.rol === 'alumno'; else autorDocente">
                  Propuesta creada por
                  <strong class="tema-autor__nombre">{{ autor.nombre }}</strong>
                  ¬∑ {{ autor.rol | titlecase }}
                  <ng-container *ngIf="autor.carrera"> ‚Äî {{ autor.carrera }}</ng-container>
                  <ng-container *ngIf="tema.docenteACargo as docente">
                    ¬∑ Docente a cargo
                    <strong class="tema-autor__nombre">{{ docente.nombre }}</strong>
                  </ng-container>
                </span>
                <ng-template #autorDocente>
                  <span>
                    Profesor creador
                    <strong class="tema-autor__nombre">{{ autor.nombre }}</strong>
                    ¬∑ {{ autor.rol | titlecase }}
                    <ng-container *ngIf="autor.carrera"> ‚Äî {{ autor.carrera }}</ng-container>
                  </span>
                </ng-template>
              </div>
              <div class="tema-autor" *ngIf="!tema.creadoPor && tema.docenteACargo as docente">
                <span class="tema-autor__icon" aria-hidden="true">üë§</span>
                <span>
                  Docente a cargo
                  <strong class="tema-autor__nombre">{{ docente.nombre }}</strong>
                  ¬∑ {{ docente.rol | titlecase }}
                  <ng-container *ngIf="docente.carrera"> ‚Äî {{ docente.carrera }}</ng-container>
                </span>
              </div>
            </div>
            <div class="tema-actions-container">
              <div class="tema-actions">
                <button
                  type="button"
                  class="btn light sm"
                  (click)="abrirDetallesTema(tema)"
                >
                  Ver detalles
                </button>
                <button
                  type="button"
                  class="btn primary sm"
                  [disabled]="!puedePedirTema(tema) || reservandoTemaId() === tema.id"
                  (click)="abrirConfirmacionTema(tema)"
                >
                  {{ etiquetaPedirTema(tema) }}
                </button>
                <button
                  type="button"
                  class="btn light sm"
                  *ngIf="puedeMostrarGestionCupos(tema)"
                  (click)="abrirGestionCupos(tema)"
                >
                  Gestionar cupos
                </button>
              </div>
              <span class="chip ghost cupos-chip">Cupos disp.: {{ tema.cuposDisponibles }} / {{ tema.cupos }}</span>
            </div>
          </li>
        </ul>

        <!-- Paginaci√≥n -->
        <div class="paginacion" *ngIf="totalPaginas() > 1">
          <div class="paginacion-info">
            Mostrando {{ rangoActual }}
          </div>
          <div class="paginacion-controles">
            <button 
              type="button" 
              class="btn light sm"
              [disabled]="paginaActual() === 1"
              (click)="cambiarPagina(paginaActual() - 1)"
            >
              ‚Üê Anterior
            </button>
            
            <div class="paginacion-numeros">
              <button
                type="button"
                *ngFor="let pagina of [].constructor(totalPaginas()); let i = index"
                class="btn-pagina"
                [class.active]="paginaActual() === i + 1"
                (click)="cambiarPagina(i + 1)"
              >
                {{ i + 1 }}
              </button>
            </div>

            <button 
              type="button" 
              class="btn light sm"
              [disabled]="paginaActual() === totalPaginas()"
              (click)="cambiarPagina(paginaActual() + 1)"
            >
              Siguiente ‚Üí
            </button>
          </div>
        </div>
      </ng-template>
    </ng-container>

    <ng-container *ngSwitchCase="'propuestas'">
      <section class="mis-propuestas">
        <p class="muted" *ngIf="propuestasCargando()">Actualizando el estado de tus propuestas‚Ä¶</p>
        <div class="err" *ngIf="!propuestasCargando() && propuestasError()">{{ propuestasError() }}</div>

        <ng-container *ngIf="!propuestasCargando() && !propuestasError()">
          <div class="alert error" *ngIf="cancelarPropuestaError()">{{ cancelarPropuestaError() }}</div>

          <ng-container *ngIf="propuestaDestacada() as propuestaPrincipal">
            <div
              class="propuesta-highlight"
              [ngClass]="clasePropuestaDestacadaEstado(propuestaPrincipal.estado)"
            >
              <div class="highlight-head">
                <div class="highlight-head-left">
                  <span class="chip ghost">Actualizada {{ propuestaPrincipal.updatedAt | date:'dd MMM yyyy' }}</span>
                </div>
                <span class="chip badge-propuesta-derecha" [ngClass]="chipClasePropuesta(propuestaPrincipal.estado)">
                  {{ etiquetaPropuestaDestacada(propuestaPrincipal) }}
                </span>
              </div>
              <h4>{{ propuestaPrincipal.titulo }}</h4>
              <p class="muted">{{ propuestaPrincipal.descripcion }}</p>
              <div class="chips">
                <span class="chip">Rama: {{ propuestaPrincipal.rama }}</span>
                <span class="chip ghost" *ngIf="propuestaPrincipal.docente">
                  Docente gu√≠a: {{ propuestaPrincipal.docente.nombre }}
                </span>
              </div>
              <p class="comentario" *ngIf="propuestaPrincipal.comentarioDecision">
                Comentario del docente:
                <span>{{ propuestaPrincipal.comentarioDecision }}</span>
              </p>
              <div class="acciones-propuesta" *ngIf="puedeAjustarPropuesta(propuestaPrincipal)">
                <p class="muted small">
                  El docente autoriz√≥ un m√°ximo de {{ propuestaPrincipal.cuposMaximoAutorizado }} integrantes.
                </p>
                <button class="btn primary" type="button" (click)="abrirAjustePropuesta(propuestaPrincipal)">
                  Ajustar cupos
                </button>
                <button
                  class="btn danger"
                  type="button"
                  (click)="cancelarPropuesta(propuestaPrincipal)"
                  [disabled]="cancelandoPropuestaId() === propuestaPrincipal.id"
                >
                  {{ cancelandoPropuestaId() === propuestaPrincipal.id ? 'Cancelando‚Ä¶' : 'Cancelar propuesta' }}
                </button>
              </div>
            </div>
          </ng-container>

          <div class="propuestas-historial" *ngIf="propuestasEnHistorial().length; else sinPropuestas">
            <h4>Historial de propuestas</h4>
            <ul class="list propuestas">
              <li *ngFor="let propuesta of propuestasEnHistorial()">
                <div class="grupo-info">
                  <div class="grupo-nombre">
                    {{ propuesta.titulo }}
                    <span class="badge propuesta" [ngClass]="estadoPropuestaClase(propuesta.estado)">
                      {{ estadoPropuestaTexto[propuesta.estado] }}
                    </span>
                  </div>
                  <div class="grupo-alumnos">{{ propuesta.objetivo }}</div>
                  <p class="comentario" *ngIf="propuesta.comentarioDecision">
                    Comentario: <span>{{ propuesta.comentarioDecision }}</span>
                  </p>
                  <div class="chips">
                    <span class="chip ghost">Actualizada {{ propuesta.updatedAt | date:'dd MMM yyyy' }}</span>
                    <span class="chip ghost" *ngIf="propuesta.docente">Docente: {{ propuesta.docente.nombre }}</span>
                </div>
                <div class="acciones-propuesta" *ngIf="puedeAjustarPropuesta(propuesta)">
                  <div class="acciones-botones">
                    <button class="btn primary sm" type="button" (click)="abrirAjustePropuesta(propuesta)">
                      Ajustar cupos
                    </button>
                    <button
                      class="btn danger sm"
                      type="button"
                      (click)="cancelarPropuesta(propuesta)"
                      [disabled]="cancelandoPropuestaId() === propuesta.id"
                    >
                      {{ cancelandoPropuestaId() === propuesta.id ? 'Cancelando‚Ä¶' : 'Cancelar propuesta' }}
                    </button>
                  </div>
                  <span class="muted small">M√°ximo {{ propuesta.cuposMaximoAutorizado }} integrantes.</span>
                </div>
              </div>
            </li>
          </ul>
          </div>

          <ng-template #sinPropuestas>
            <p class="muted">A√∫n no env√≠as propuestas personalizadas.</p>
          </ng-template>
        </ng-container>
      </section>
    </ng-container>
  </ng-container>
</div>

<!-- MODAL DETALLES DEL TEMA -->
<div class="backdrop" *ngIf="temaParaDetalles()" (click)="cerrarDetallesTema()"></div>
<div class="modal detalles-modal" *ngIf="temaParaDetalles() as temaDetalles" role="dialog" aria-modal="true">
  <div class="modal-head">
    <h4 class="ttl-detalles">{{ temaDetalles.titulo }}</h4>
    <button class="icon" type="button" (click)="cerrarDetallesTema()" aria-label="Cerrar">‚úï</button>
  </div>
  <div class="modal-body tema-detalles">
    <div class="seccion-contenido">
      <h6 class="subtitulo-seccion">Descripci√≥n</h6>
      <p class="texto-contenido">{{ temaDetalles.descripcion }}</p>
    </div>

    <div class="chips meta">
      <span class="chip ghost">Cupos disponibles: {{ temaDetalles.cuposDisponibles }} / {{ temaDetalles.cupos }}</span>
      <span class="chip">{{ temaDetalles.carrera }}</span>
    </div>

    <div class="tema-confirmacion__autor">
      <span aria-hidden="true">üë§</span>
      <span>
        Docente a cargo:
        <strong>{{ temaDetalles.docenteACargo?.nombre || temaDetalles.creadoPor?.nombre || 'Por asignar' }}</strong>
        <ng-container *ngIf="temaDetalles.docenteACargo?.rol || temaDetalles.creadoPor?.rol">
          ¬∑ {{ (temaDetalles.docenteACargo?.rol || temaDetalles.creadoPor?.rol) | titlecase }}
        </ng-container>
        <ng-container *ngIf="temaDetalles.docenteACargo?.carrera || temaDetalles.creadoPor?.carrera">
          ‚Äî {{ temaDetalles.docenteACargo?.carrera || temaDetalles.creadoPor?.carrera }}
        </ng-container>
      </span>
    </div>
    
    <div class="tema-confirmacion__requisitos" *ngIf="temaDetalles.requisitos?.length; else sinRequisitosDetalle">
      <h6>Requisitos del tema</h6>
      <ul>
        <li *ngFor="let requisito of temaDetalles.requisitos">{{ requisito }}</li>
      </ul>
    </div>
    <ng-template #sinRequisitosDetalle>
      <p class="muted" style="margin: 0">Este tema no especifica requisitos adicionales.</p>
    </ng-template>
  </div>
  <div class="actions">
    <button type="button" class="btn primary" (click)="cerrarDetallesTema()">Cerrar</button>
  </div>
</div>

<div class="backdrop" *ngIf="showAjustePropuesta()" (click)="cerrarAjustePropuesta()"></div>
<div
  class="modal ajuste-modal"
  *ngIf="showAjustePropuesta() && propuestaParaAjuste() as propuestaAjuste"
  role="dialog"
  aria-modal="true"
>
  <div class="modal-head">
    <h4 class="ttl" style="margin: 0">Ajustar cupos del grupo</h4>
    <button class="icon" type="button" (click)="cerrarAjustePropuesta()" aria-label="Cerrar">‚úï</button>
  </div>

  <form class="grid ajuste-form" [formGroup]="ajusteForm" (ngSubmit)="guardarAjustePropuesta()" novalidate>
    <div class="field">
      <label for="ajusteCupos">Integrantes del grupo <span class="req">*</span></label>
      <input
        type="number"
        id="ajusteCupos"
        formControlName="cupos"
        min="1"
        (change)="ajustarCorreosAjustePorCupos()"
      />
      <div class="err" *ngIf="ajusteForm.get('cupos')?.touched && ajusteForm.get('cupos')?.hasError('required')">
        Debes indicar la cantidad de integrantes.
      </div>
      <div class="err" *ngIf="ajusteForm.get('cupos')?.touched && ajusteForm.get('cupos')?.hasError('min')">
        El grupo debe tener al menos 1 integrante.
      </div>
      <div class="err" *ngIf="ajusteForm.get('cupos')?.touched && ajusteForm.get('cupos')?.hasError('max')">
        Puedes solicitar hasta 6 integrantes.
      </div>
      <p class="muted small" *ngIf="propuestaAjuste.cuposMaximoAutorizado">
        M√°ximo autorizado por el docente: {{ propuestaAjuste.cuposMaximoAutorizado }} integrantes.
      </p>
    </div>

    <div class="field full">
      <label>Correos de tus compa√±eros</label>
      <p class="muted small">
        Opcional: ingresa hasta {{ maxCorreosPermitidosAjuste() }} correos distintos.
      </p>
      <div formArrayName="correos" class="correos-list">
        <div class="correo-item" *ngFor="let ctrl of correosAjuste.controls; let i = index">
          <input type="email" [formControlName]="i" placeholder="correo@ejemplo.cl" />
          <button type="button" class="icon" (click)="removerCorreoAjuste(i)" aria-label="Eliminar correo">‚úï</button>
          <div class="err" *ngIf="correoAjusteTieneError(i, 'email')">Ingresa un correo v√°lido.</div>
        </div>
      </div>
      <button
        type="button"
        class="btn light sm"
        (click)="agregarCorreoAjuste()"
        [disabled]="!puedeAgregarCorreoAjuste() || ajusteEnCurso()"
      >Agregar correo</button>
    </div>

    <div class="err full" *ngIf="ajusteError()">{{ ajusteError() }}</div>

    <div class="actions full">
      <button type="button" class="btn light" (click)="cerrarAjustePropuesta()" [disabled]="ajusteEnCurso()">Cancelar</button>
      <button type="submit" class="btn primary" [disabled]="ajusteEnCurso()">
        {{ ajusteEnCurso() ? 'Guardando‚Ä¶' : 'Confirmar cupos' }}
      </button>
    </div>
  </form>
</div>

<div class="backdrop" *ngIf="temaSeleccionado()" (click)="cerrarConfirmacionTema()"></div>
<div class="modal confirm-modal" *ngIf="temaSeleccionado() as temaEnConfirmacion" role="dialog" aria-modal="true">
  <div class="modal-head">
    <span class="chip ghost">Cupos: {{ temaEnConfirmacion.cuposDisponibles }} / {{ temaEnConfirmacion.cupos }}</span>
    <h4 class="ttl" style="margin: 0">Confirmar reserva</h4>
    <button class="icon" (click)="cerrarConfirmacionTema()" aria-label="Cerrar">‚úï</button>
  </div>
  <div class="modal-body tema-confirmacion">
    <div class="chips meta">
      <span class="chip ghost">Carrera: {{ temaEnConfirmacion.carrera }}</span>
    </div>
    <div>
      <h5>{{ temaEnConfirmacion.titulo }}</h5>
      <p class="descripcion">{{ temaEnConfirmacion.descripcion }}</p>
    </div>
    <div class="tema-confirmacion__autor">
      <span aria-hidden="true">üë§</span>
      <span>
        Profesor responsable:
        <strong>{{ temaEnConfirmacion.docenteACargo?.nombre || temaEnConfirmacion.creadoPor?.nombre || 'Por asignar' }}</strong>
      </span>
    </div>
    
    <ng-template #sinRequisitos>
      <p class="muted" style="margin: 0">Este tema no especifica requisitos adicionales.</p>
    </ng-template>
    <p>¬øDeseas continuar con la reserva?</p>
  </div>
  <div class="actions">
    <button type="button" class="btn light" (click)="cerrarConfirmacionTema()">Cancelar</button>
    <button
      type="button"
      class="btn primary"
      [disabled]="reservandoTemaId() === temaEnConfirmacion.id"
      (click)="confirmarReservaTema()"
    >
      {{ reservandoTemaId() === temaEnConfirmacion.id ? 'Reservando‚Ä¶' : 'Confirmar' }}
    </button>
  </div>
</div>

<div class="backdrop" *ngIf="temaParaCupos()" (click)="cerrarGestionCupos()"></div>
<div class="modal cupos-modal" *ngIf="temaParaCupos() as temaGestion" role="dialog" aria-modal="true">
  <div class="modal-head">
    <h4 class="ttl" style="margin: 0">Gestionar cupos</h4>
    <button class="icon" type="button" (click)="cerrarGestionCupos()" aria-label="Cerrar">‚úï</button>
  </div>
  <div class="modal-body">
    <p class="muted" style="margin-top: 0">
      Ingresa los correos electr√≥nicos de tus compa√±eros para completar los cupos disponibles del tema.
    </p>
    <div class="chips meta">
      <span class="chip ghost">Cupos totales: {{ temaGestion.cupos }}</span>
      <span class="chip ghost">Integrantes registrados: {{ temaGestion.inscripcionesActivas.length }}</span>
    </div>

    <div class="alert success" *ngIf="gestionCuposMensaje()">{{ gestionCuposMensaje() }}</div>
    <div class="alert error" *ngIf="gestionCuposError()">{{ gestionCuposError() }}</div>

    <form [formGroup]="cuposForm" (ngSubmit)="guardarCompaneros()" class="grid cupos-grid" novalidate>
      <div formArrayName="correos" class="full correos-array">
        <div class="field full correo-field" *ngFor="let control of correosForm.controls; let i = index">
          <label [attr.for]="'correo-companero-' + i">Correo del compa√±ero {{ i + 1 }}</label>
          <div class="correo-input">
            <input
              type="email"
              [id]="'correo-companero-' + i"
              [formControlName]="i"
              placeholder="nombre@ejemplo.cl"
              [readonly]="guardandoCompaneros()"
            />
            <button
              type="button"
              class="btn light sm"
              (click)="removerCampoCorreo(i)"
              [disabled]="guardandoCompaneros() || correosForm.length <= 1"
            >
              Quitar
            </button>
          </div>
          <div class="err" *ngIf="correoControlTieneError(i, 'email')">Correo electr√≥nico inv√°lido.</div>
        </div>
      </div>

      <div class="acciones-correos" *ngIf="puedeAgregarOtroCorreo(temaGestion)">
        <button type="button" class="btn light sm" (click)="agregarCampoCorreo()" [disabled]="guardandoCompaneros()">
          + Agregar correo
        </button>
      </div>

      <div class="field full">
        <h5 style="margin: 16px 0 8px">Integrantes registrados</h5>
        <div class="chips participantes" *ngIf="temaGestion.inscripcionesActivas.length; else sinIntegrantes">
          <span class="chip" *ngFor="let integrante of temaGestion.inscripcionesActivas">
            {{ integrante.nombre }}
            <span *ngIf="integrante.correo"> ¬∑ {{ integrante.correo }}</span>
          </span>
        </div>
        <ng-template #sinIntegrantes>
          <p class="muted" style="margin: 0">A√∫n no hay compa√±eros registrados.</p>
        </ng-template>
      </div>

      <div class="actions full">
        <button type="button" class="btn light" (click)="cerrarGestionCupos()" [disabled]="guardandoCompaneros()">
          Cerrar
        </button>
        <button type="submit" class="btn primary" [disabled]="guardandoCompaneros()">
          {{ guardandoCompaneros() ? 'Guardando‚Ä¶' : 'Guardar cambios' }}
        </button>
      </div>
    </form>
  </div>
</div>

<div class="backdrop" *ngIf="showPostulacion()" (click)="togglePostulacion(false)"></div>
<div class="modal" *ngIf="showPostulacion()" role="dialog" aria-modal="true">
  <div class="modal-head">
    <h4 class="ttl" style="margin: 0">Solicitud de Tema</h4>
    <button class="icon" (click)="togglePostulacion(false)" aria-label="Cerrar">‚úï</button>
  </div>

  <form [formGroup]="postulacionForm" (ngSubmit)="submitPostulacion()" class="grid" novalidate>
    <div class="muted" *ngIf="profesoresCargando()">Cargando docentes disponibles...</div>
    <div class="err" *ngIf="profesoresError()">{{ profesoresError() }}</div>
    <div class="muted" *ngIf="!profesoresCargando() && !profesoresError() && !profesores().length">
      Por ahora no hay docentes disponibles en el listado.
    </div>
    <div class="err" *ngIf="postulacionError()">{{ postulacionError() }}</div>

    <div class="field full">
      <label for="titulo">Nombre del tema <span class="req">*</span></label>
      <input id="titulo" type="text" formControlName="titulo" />
      <div class="err" *ngIf="hasError('titulo','required')">Obligatorio.</div>
      <div class="err" *ngIf="hasError('titulo','maxlength')">M√°x. 160 caracteres.</div>
    </div>

    <div class="field full">
      <label for="objetivo">Objetivo <span class="req">*</span></label>
      <input id="objetivo" type="text" formControlName="objetivo" />
      <div class="err" *ngIf="hasError('objetivo','required')">Obligatorio.</div>
      <div class="err" *ngIf="hasError('objetivo','maxlength')">M√°x. 300 caracteres.</div>
    </div>

    <div class="field full">
      <label for="descripcion">Breve descripci√≥n <span class="req">*</span></label>
      <textarea id="descripcion" rows="5" formControlName="descripcion"></textarea>
      <div class="err" *ngIf="hasError('descripcion','required')">Obligatorio.</div>
      <div class="err" *ngIf="hasError('descripcion','maxlength')">M√°x. 1200 caracteres.</div>
    </div>

    <div class="field">
      <label for="rama">Rama de la carrera <span class="req">*</span></label>
      <select id="rama" formControlName="rama">
        <option value="" disabled>Selecciona una rama</option>
        <option *ngFor="let r of ramas" [value]="r">{{ r }}</option>
      </select>
      <div class="err" *ngIf="hasError('rama','required')">Selecciona una rama.</div>
    </div>

    <div class="field">
      <label for="prof1">Profesor gu√≠a (Preferencia 1) <span class="req">*</span></label>
      <select id="prof1" formControlName="prof1">
        <option value="" disabled>Selecciona</option>
        <option *ngFor="let p of profesoresFiltrados()" [value]="p.id">{{ p.nombre }}</option>
      </select>
      <div class="err" *ngIf="hasError('prof1','required')">Selecciona una opci√≥n.</div>
    </div>

    <div class="field">
      <label for="prof2">Profesor gu√≠a (Preferencia 2)</label>
      <select id="prof2" formControlName="prof2">
        <option value="">(Opcional)</option>
        <option *ngFor="let p of profesoresFiltrados()" [value]="p.id">{{ p.nombre }}</option>
      </select>
    </div>

    <div class="field">
      <label for="prof3">Profesor gu√≠a (Preferencia 3)</label>
      <select id="prof3" formControlName="prof3">
        <option value="">(Opcional)</option>
        <option *ngFor="let p of profesoresFiltrados()" [value]="p.id">{{ p.nombre }}</option>
      </select>
    </div>

    <div class="field">
      <label for="cupos">Cupos del grupo <span class="req">*</span></label>
      <input
        id="cupos"
        type="number"
        formControlName="cupos"
        min="1"
        max="6"
        (change)="ajustarCompanerosPorCupos()"
      />
      <div class="err" *ngIf="hasError('cupos','required')">Debes indicar la cantidad de cupos.</div>
      <div class="err" *ngIf="hasError('cupos','min')">El grupo debe tener al menos 1 integrante.</div>
      <div class="err" *ngIf="hasError('cupos','max')">Puedes solicitar hasta 6 cupos.</div>
    </div>

    <div class="field full">
      <label>Correos de compa√±eros</label>
      <p class="muted" style="margin: 0 0 8px">
        Opcional: agrega los correos de tus compa√±eros para completar los cupos del grupo.
      </p>
      <div class="correos-array">
        <div class="correo-input" *ngFor="let control of companerosPostulacion.controls; index as i">
          <input type="email" [formControl]="control" placeholder="compa√±ero@utem.cl" />
          <button type="button" class="btn ghost" (click)="removerCompaneroPostulacion(i)">Quitar</button>
          <div class="err" *ngIf="companeroControlTieneError(i,'email')">Ingresa un correo v√°lido.</div>
        </div>
      </div>
      <div class="acciones-correos">
        <button
          type="button"
          class="btn ghost"
          (click)="agregarCompaneroPostulacion()"
          [disabled]="!puedeAgregarCompaneroPostulacion()"
        >
          Agregar compa√±ero
        </button>
      </div>
    </div>

    <div class="field full" *ngIf="profesoresDuplicados">
      <span class="err">Las preferencias no pueden repetir al mismo profesor.</span>
    </div>

    <div class="actions full">
      <button type="button" class="btn light" (click)="togglePostulacion(false)">Cancelar</button>
      <button type="submit" class="btn primary" [disabled]="enviandoPropuesta()">
        {{ enviandoPropuesta() ? 'Enviando‚Ä¶' : 'Enviar postulaci√≥n' }}
      </button>
    </div>
  </form>
</div>