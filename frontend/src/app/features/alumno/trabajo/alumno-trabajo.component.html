<div class="card">
  <h2 class="ttl">Trabajo de Título</h2>

  <ng-container *ngIf="nivelesDisponibles().length; else sinNiveles">
    <div class="tabs">
      <button *ngIf="tieneNivel('i')" [class.active]="nivelSeleccionado() === 'i'" (click)="seleccionarNivel('i')">
        T. Título I
      </button>
      <button *ngIf="tieneNivel('ii')" [class.active]="nivelSeleccionado() === 'ii'" (click)="seleccionarNivel('ii')">
        T. Título II
      </button>
      <a class="btn link" routerLink="/alumno/temas">Ver temas disponibles</a>
    </div>

    <p class="subtitle" *ngIf="nivelTitulo()">Tu progreso en {{ nivelTitulo() }}</p>

    <ng-container *ngIf="resumenNivel() as resumen">
      <div class="chips metrics">
        <span class="chip highlight">Avance general: {{ resumen.avance }}%</span>
        <span class="chip ghost">Entregas aprobadas: {{ resumen.aprobadas }} / {{ resumen.totales }}</span>
        <span class="chip">Próximo hito: {{ resumen.proximoHito }}</span>
        <span class="chip">Último feedback: {{ resumen.ultimoFeedback }}</span>
        <span class="chip">Profesor guía: {{ resumen.profesorGuia }}</span>
      </div>
    </ng-container>

    <div class="upload-card" *ngIf="entregaDestacada() as destacada; else sinDestacada">
      <div class="upload-header">
        <h3>{{ destacada.encabezado }}</h3>
        <span class="badge" [ngClass]="destacada.estado">{{ destacada.estadoEtiqueta }}</span>
      </div>
      <p class="upload-title">{{ destacada.nombre }}</p>
      <p class="muted">{{ destacada.descripcion }}</p>
      <div class="chips">
        <span class="chip">{{ destacada.fecha }}</span>
        <span class="chip ghost" *ngIf="destacada.proximoPaso">Próximo paso: {{ destacada.proximoPaso }}</span>
      </div>
      <div class="upload-actions">
        <button class="btn primary" routerLink="/alumno/entrega">Gestionar entregas</button>
      </div>
    </div>

    <ng-template #sinDestacada>
      <div class="upload-card empty">
        <h3>Sin entregas destacadas</h3>
        <p class="muted">Cuando registres avances verás aquí un resumen de tu próxima acción.</p>
        <div class="upload-actions">
          <a class="btn link" routerLink="/alumno/entrega">Ir a entregas</a>
        </div>
      </div>
    </ng-template>

    <h3 class="section-title">Entregas e hitos recientes</h3>

    <ng-container *ngIf="entregasPorNivel().length; else sinEntregas">
      <ul class="list">
        <li *ngFor="let item of entregasPorNivel()">
          <div class="grupo-info">
            <div class="grupo-nombre">
              {{ item.nombre }}
              <span class="badge" [ngClass]="item.estado">{{ estadoTexto[item.estado] }}</span>
              <span class="badge soft">{{ item.badge }}</span>
              <span *ngIf="item.alerta" class="alert-icon">{{ item.alerta }}</span>
              <span *ngIf="item.estado === 'aprobado'" class="status-icon" aria-label="Aprobado">✓</span>
            </div>
            <div class="grupo-alumnos">{{ item.descripcion }}</div>
            <div class="chips">
              <span class="chip">{{ item.fecha }}</span>
              <span class="chip ghost" *ngIf="item.proximoPaso">Próximo paso: {{ item.proximoPaso }}</span>
            </div>
          </div>
        </li>
      </ul>
    </ng-container>

    <ng-template #sinEntregas>
      <p class="muted">Aún no tienes entregas registradas en {{ nivelTitulo() }}.</p>
    </ng-template>
  </ng-container>

  <ng-template #sinNiveles>
    <p class="muted">
      Tu plan de estudios no contempla trabajo de título. Puedes revisar los temas disponibles desde la sección
      <a routerLink="/alumno/temas">Temas</a>.
    </p>
  </ng-template>
</div>
