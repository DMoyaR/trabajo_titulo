
<div class="card">
  <h2 class="ttl">Trabajo de T√≠tulo</h2>

  <div class="tabs">
    <button *ngIf="tieneNivel('i')" [class.active]="tab() === 'i'" (click)="tab.set('i')">T. T√≠tulo I</button>
    <button *ngIf="tieneNivel('ii')" [class.active]="tab() === 'ii'" (click)="tab.set('ii')">T. T√≠tulo II</button>
    <button [class.active]="tab() === 'temas'" (click)="tab.set('temas')">Temas</button>
    <button [class.active]="tab() === 'propuestas'" (click)="tab.set('propuestas')">Propuestas</button>

  </div>


  <ng-container [ngSwitch]="tab()">
    <ng-container *ngSwitchCase="'temas'">
      <div class="row-head">
        <h3>Temas para Trabajo de t√≠tulo</h3>
        <button class="btn primary" (click)="togglePostulacion(true)">
          + Postular / Proponer tema
        </button>
      </div>
      <p class="muted">Completa el formulario para solicitar o proponer un tema.</p>

      <section class="mis-propuestas">
        <p class="muted" *ngIf="propuestasCargando()">Actualizando el estado de tus propuestas‚Ä¶</p>
        <div class="err" *ngIf="!propuestasCargando() && propuestasError()">{{ propuestasError() }}</div>

        <ng-container *ngIf="!propuestasCargando() && !propuestasError()">
          <ng-container *ngIf="propuestaDestacada() as propuestaPrincipal; else sinPropuestaDestacada">
            <div class="propuesta-highlight">
              <div class="highlight-head">
                <span class="chip" [ngClass]="chipClasePropuesta(propuestaPrincipal.estado)">
                  {{ etiquetaPropuestaDestacada(propuestaPrincipal) }}
                </span>
                <span class="chip ghost">Actualizada {{ propuestaPrincipal.updatedAt | date:'dd MMM yyyy' }}</span>
              </div>
              <h4>{{ propuestaPrincipal.titulo }}</h4>
              <p class="muted">{{ propuestaPrincipal.descripcion }}</p>
              <div class="chips">
                <span class="chip">Rama: {{ propuestaPrincipal.rama }}</span>
                <span class="chip ghost" *ngIf="propuestaPrincipal.docente">
                  Docente gu√≠a: {{ propuestaPrincipal.docente.nombre }}
                </span>
              </div>
              <p class="comentario" *ngIf="propuestaPrincipal.comentarioDecision">
                Comentario del docente:
                <span>{{ propuestaPrincipal.comentarioDecision }}</span>
              </p>
            </div>
          </ng-container>
        </ng-container>
      </section>

      <ng-template #sinPropuestaDestacada>
        <p class="muted">A√∫n no tienes propuestas aceptadas ni pendientes.</p>
      </ng-template>

      <ng-container *ngIf="temasCargando(); else temasContenido">
        <p class="muted" style="margin-top: 1rem">Cargando temas disponibles...</p>
      </ng-container>

      <ng-template #temasContenido>
        <div class="err" *ngIf="temasError(); else temasLista">{{ temasError() }}</div>
      </ng-template>

      <ng-template #sinTemas>
        <p class="muted" style="margin-top: 1rem">A√∫n no hay temas disponibles.</p>
      </ng-template>

      <ng-template #temasLista>
        <div class="alert success" *ngIf="reservaMensaje()">{{ reservaMensaje() }}</div>
        <div class="alert error" *ngIf="reservaError()">{{ reservaError() }}</div>
        <ul class="list topics" *ngIf="temas().length; else sinTemas">
          <li *ngFor="let tema of temas()">
            <div class="grupo-info">
              <div class="grupo-nombre">
                {{ tema.titulo }}
                <span class="badge">{{ tema.carrera }}</span>
              </div>
              <div class="grupo-alumnos">{{ tema.descripcion }}</div>
              <div class="tema-autor" *ngIf="tema.creadoPor as autor">
                <span class="tema-autor__icon" aria-hidden="true">üë§</span>
                <span>
                  {{ autor.rol === 'docente' ? 'Profesor creador' : 'Creado por' }}:
                  <strong class="tema-autor__nombre">{{ autor.nombre }}</strong>
                  ¬∑ {{ autor.rol | titlecase }}
                  <ng-container *ngIf="autor.carrera"> ‚Äî {{ autor.carrera }}</ng-container>
                </span>
              </div>
              <div class="chips meta">
                <span class="chip ghost">Cupos disp.: {{ tema.cuposDisponibles }} / {{ tema.cupos }}</span>
                <span class="chip success" *ngIf="tema.tieneCupoPropio">Tu cupo reservado</span>
              </div>
              <div class="chips requisitos" *ngIf="tema.requisitos?.length">
                <span class="chip" *ngFor="let req of tema.requisitos">{{ req }}</span>
              </div>
            </div>
            <button
              type="button"
              class="btn primary sm"
              [disabled]="!puedePedirTema(tema) || reservandoTemaId() === tema.id"
              (click)="abrirConfirmacionTema(tema)"
            >
              {{ etiquetaPedirTema(tema) }}
            </button>
          </li>
        </ul>
      </ng-template>
    </ng-container>
    <ng-container *ngSwitchCase="'propuestas'">
      <section class="mis-propuestas">
        <p class="muted" *ngIf="propuestasCargando()">Actualizando el estado de tus propuestas‚Ä¶</p>
        <div class="err" *ngIf="!propuestasCargando() && propuestasError()">{{ propuestasError() }}</div>

        <ng-container *ngIf="!propuestasCargando() && !propuestasError()">
          <div class="propuestas-historial" *ngIf="propuestasEnHistorial().length; else sinPropuestas">
            <h4>Historial de propuestas</h4>
            <ul class="list propuestas">
              <li *ngFor="let propuesta of propuestasEnHistorial()">
                <div class="grupo-info">
                  <div class="grupo-nombre">
                    {{ propuesta.titulo }}
                    <span class="badge propuesta" [ngClass]="estadoPropuestaClase(propuesta.estado)">
                      {{ estadoPropuestaTexto[propuesta.estado] }}
                    </span>
                  </div>
                  <div class="grupo-alumnos">{{ propuesta.objetivo }}</div>
                  <p class="comentario" *ngIf="propuesta.comentarioDecision">
                    Comentario: <span>{{ propuesta.comentarioDecision }}</span>
                  </p>
                  <div class="chips">
                    <span class="chip ghost">Actualizada {{ propuesta.updatedAt | date:'dd MMM yyyy' }}</span>
                    <span class="chip ghost" *ngIf="propuesta.docente">Docente: {{ propuesta.docente.nombre }}</span>
                  </div>
                </div>
              </li>
            </ul>
          </div>

          <ng-template #sinPropuestas>
            <p class="muted">A√∫n no env√≠as propuestas personalizadas.</p>
          </ng-template>
        </ng-container>
      </section>
    </ng-container>
    <ng-container *ngSwitchDefault>
      <p class="subtitle">Tu progreso en {{ nivelTitulo() }}</p>

      <ng-container *ngIf="resumenNivel() as resumen">
        <div class="chips metrics">
          <span class="chip highlight">Avance general: {{ resumen.avance }}%</span>
          <span class="chip ghost">Entregas aprobadas: {{ resumen.aprobadas }} / {{ resumen.totales }}</span>
          <span class="chip">Pr√≥ximo hito: {{ resumen.proximoHito }}</span>
          <span class="chip">√öltimo feedback: {{ resumen.ultimoFeedback }}</span>
          <span class="chip">Profesor gu√≠a: {{ resumen.profesorGuia }}</span>
        </div>
      </ng-container>

      <div class="upload-card" *ngIf="entregaDestacada() as destacada; else sinDestacada">
        <div class="upload-header">
          <h3>{{ destacada.encabezado }}</h3>
          <span class="badge" [ngClass]="destacada.estado">{{ destacada.estadoEtiqueta }}</span>
        </div>
        <p class="upload-title">{{ destacada.nombre }}</p>
        <p class="muted">{{ destacada.descripcion }}</p>
        <div class="chips">
          <span class="chip">{{ destacada.fecha }}</span>
          <span class="chip ghost" *ngIf="destacada.proximoPaso">Pr√≥ximo paso: {{ destacada.proximoPaso }}</span>
        </div>
        <div class="upload-actions">
          <button class="btn primary" routerLink="/alumno/entrega">Gestionar entregas </button>
        </div>
      </div>

      <ng-template #sinDestacada>
        <div class="upload-card empty">
          <h3>Sin entregas destacadas</h3>
          <p class="muted">Cuando registres avances ver√°s aqu√≠ un resumen de tu pr√≥xima acci√≥n.</p>
          <div class="upload-actions">
            <a class="btn link" routerLink="/alumno/entrega">Ir a entregas</a>
          </div>
        </div>
      </ng-template>

      <h3 class="section-title">Entregas e hitos recientes</h3>

      <ng-container *ngIf="entregasPorNivel().length; else sinEntregas">
        <ul class="list">
          <li *ngFor="let item of entregasPorNivel()">
            <div class="grupo-info">
              <div class="grupo-nombre">
                {{ item.nombre }}
                <span class="badge" [ngClass]="item.estado">{{ estadoTexto[item.estado] }}</span>
                <span class="badge soft">{{ item.badge }}</span>
                <span *ngIf="item.alerta" class="alert-icon">{{ item.alerta }}</span>
                <span *ngIf="item.estado === 'aprobado'" class="status-icon" aria-label="Aprobado">‚úì</span>
              </div>
              <div class="grupo-alumnos">{{ item.descripcion }}</div>
              <div class="chips">
                <span class="chip">{{ item.fecha }}</span>
                <span class="chip ghost" *ngIf="item.proximoPaso">Pr√≥ximo paso: {{ item.proximoPaso }}</span>
              </div>
            </div>
          </li>
        </ul>
      </ng-container>

      <ng-template #sinEntregas>
        <p class="muted">A√∫n no tienes entregas registradas en {{ nivelTitulo() }}.</p>
      </ng-template>
    </ng-container>
  </ng-container>

<!-- CORREGIDO: usa getter o bracket notation -->
    <div class="backdrop" *ngIf="temaSeleccionado()" (click)="cerrarConfirmacionTema()"></div>
    <div class="modal confirm-modal" *ngIf="temaSeleccionado() as temaEnConfirmacion" role="dialog" aria-modal="true">
      <div class="modal-head">
        <h4 class="ttl" style="margin: 0">Confirmar reserva</h4>
        <button class="icon" (click)="cerrarConfirmacionTema()" aria-label="Cerrar">‚úï</button>
      </div>
      <div class="modal-body tema-confirmacion">
        <div class="chips meta">
          <span class="chip ghost">Cupos disponibles: {{ temaEnConfirmacion.cuposDisponibles }} / {{ temaEnConfirmacion.cupos }}</span>
          <span class="chip ghost">Carrera: {{ temaEnConfirmacion.carrera }}</span>
        </div>
        <div>
          <h5>{{ temaEnConfirmacion.titulo }}</h5>
          <p class="descripcion">{{ temaEnConfirmacion.descripcion }}</p>
        </div>
        <div class="tema-confirmacion__autor">
          <span aria-hidden="true">üë§</span>
          <span>
            Profesor responsable:
            <strong>{{ temaEnConfirmacion.creadoPor?.nombre || 'Por asignar' }}</strong>
          </span>
        </div>
        <div class="tema-confirmacion__requisitos" *ngIf="temaEnConfirmacion.requisitos?.length; else sinRequisitos">
          <h6>Requisitos del tema</h6>
          <ul>
            <li *ngFor="let requisito of temaEnConfirmacion.requisitos">{{ requisito }}</li>
          </ul>
        </div>
        <ng-template #sinRequisitos>
          <p class="muted" style="margin: 0">Este tema no especifica requisitos adicionales.</p>
        </ng-template>
        <p>¬øDeseas continuar con la reserva?</p>
      </div>
      <div class="actions">
        <button type="button" class="btn light" (click)="cerrarConfirmacionTema()">Cancelar</button>
        <button
          type="button"
          class="btn primary"
          [disabled]="reservandoTemaId() === temaEnConfirmacion.id"
          (click)="confirmarReservaTema()"
        >
          {{ reservandoTemaId() === temaEnConfirmacion.id ? 'Reservando‚Ä¶' : 'Confirmar' }}
        </button>
      </div>
    </div>

    <div class="backdrop" *ngIf="showPostulacion()" (click)="togglePostulacion(false)"></div>
        <div class="modal" *ngIf="showPostulacion()" role="dialog" aria-modal="true">
        <div class="modal-head">
        <h4 class="ttl" style="margin: 0">Solicitud de Tema</h4>
        <button class="icon" (click)="togglePostulacion(false)" aria-label="Cerrar">‚úï</button>
      </div>

        <form [formGroup]="postulacionForm" (ngSubmit)="submitPostulacion()" class="grid" novalidate>
          <div class="muted" *ngIf="profesoresCargando()">Cargando docentes disponibles...</div>
          <div class="err" *ngIf="profesoresError()">{{ profesoresError() }}</div>
          <div class="muted" *ngIf="!profesoresCargando() && !profesoresError() && !profesores().length">
            Por ahora no hay docentes disponibles en el listado.
          </div>
          <div class="err" *ngIf="postulacionError()">{{ postulacionError() }}</div>

        <div class="field full">
          <label for="titulo">Nombre del tema <span class="req">*</span></label>
          <input id="titulo" type="text" formControlName="titulo" />
          <div class="err" *ngIf="hasError('titulo','required')">Obligatorio.</div>
          <div class="err" *ngIf="hasError('titulo','maxlength')">M√°x. 160 caracteres.</div>
        </div>

        <div class="field full">
          <label for="objetivo">Objetivo <span class="req">*</span></label>
          <input id="objetivo" type="text" formControlName="objetivo" />
          <div class="err" *ngIf="hasError('objetivo','required')">Obligatorio.</div>
          <div class="err" *ngIf="hasError('objetivo','maxlength')">M√°x. 300 caracteres.</div>
        </div>

        <div class="field full">
          <label for="descripcion">Breve descripci√≥n <span class="req">*</span></label>
          <textarea id="descripcion" rows="5" formControlName="descripcion"></textarea>
          <div class="err" *ngIf="hasError('descripcion','required')">Obligatorio.</div>
          <div class="err" *ngIf="hasError('descripcion','maxlength')">M√°x. 1200 caracteres.</div>
        </div>

        <div class="field">
          <label for="rama">Rama de la carrera <span class="req">*</span></label>
          <select id="rama" formControlName="rama">
            <option value="" disabled>Selecciona una rama</option>
            <option *ngFor="let r of ramas" [value]="r">{{ r }}</option>
          </select>
          <div class="err" *ngIf="hasError('rama','required')">Selecciona una rama.</div>
        </div>

        <div class="field">
          <label for="prof1">Profesor gu√≠a (Preferencia 1) <span class="req">*</span></label>
          <select id="prof1" formControlName="prof1">
            <option value="" disabled>Selecciona</option>
            <option *ngFor="let p of profesoresFiltrados()" [value]="p.id">{{ p.nombre }}</option>
          </select>
          <div class="err" *ngIf="hasError('prof1','required')">Selecciona una opci√≥n.</div>
        </div>

        <div class="field">
          <label for="prof2">Profesor gu√≠a (Preferencia 2)</label>
          <select id="prof2" formControlName="prof2">
            <option value="">(Opcional)</option>
            <option *ngFor="let p of profesoresFiltrados()" [value]="p.id">{{ p.nombre }}</option>
          </select>
        </div>

        <div class="field">
          <label for="prof3">Profesor gu√≠a (Preferencia 3)</label>
          <select id="prof3" formControlName="prof3">
            <option value="">(Opcional)</option>
            <option *ngFor="let p of profesoresFiltrados()" [value]="p.id">{{ p.nombre }}</option>
          </select>
        </div>

        <div class="field full" *ngIf="profesoresDuplicados">
          <span class="err">Las preferencias no pueden repetir al mismo profesor.</span>
        </div>

        <div class="actions full">
          <button type="button" class="btn light" (click)="togglePostulacion(false)">Cancelar</button>
          <button type="submit" class="btn primary" [disabled]="enviandoPropuesta()">
            {{ enviandoPropuesta() ? 'Enviando‚Ä¶' : 'Enviar postulaci√≥n' }}
          </button>
        </div>
      </form>
    </div>
  </div>