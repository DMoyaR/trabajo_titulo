
<div class="card">
  <h2 class="ttl">Trabajo de T√≠tulo</h2>

  <div class="tabs">
    <button [class.active]="tab() === 'i'" (click)="tab.set('i')">T. T√≠tulo I</button>
    <button [class.active]="tab() === 'ii'" (click)="tab.set('ii')">T. T√≠tulo II</button>
    <button [class.active]="tab() === 'temas'" (click)="tab.set('temas')">Temas</button>

  </div>


  <ng-container *ngIf="tab() !== 'temas'; else temasTpl">
    <p class="subtitle">Tu progreso en {{ nivelTitulo() }}</p>

    <ng-container *ngIf="resumenNivel() as resumen">
      <div class="chips metrics">
        <span class="chip highlight">Avance general: {{ resumen.avance }}%</span>
        <span class="chip ghost">Entregas aprobadas: {{ resumen.aprobadas }} / {{ resumen.totales }}</span>
        <span class="chip">Pr√≥ximo hito: {{ resumen.proximoHito }}</span>
        <span class="chip">√öltimo feedback: {{ resumen.ultimoFeedback }}</span>
        <span class="chip">Profesor gu√≠a: {{ resumen.profesorGuia }}</span>
      </div>
</ng-container>
      

    <div class="upload-card">
      <h3>Subir entrega</h3>
      <div class="drop">üì• Arrastra aqu√≠ tus bit√°coras, informes o anexos</div>
      <p class="muted">Tus archivos quedar√°n disponibles para tu profesor gu√≠a.</p>
    </div>

    <h3 class="section-title">Entregas y hitos recientes</h3>

    <ng-container *ngIf="entregasPorNivel().length; else sinEntregas">
      <ul class="list">
        <li *ngFor="let item of entregasPorNivel()">
          <div class="grupo-info">
            <div class="grupo-nombre">
              {{ item.nombre }}
              <span class="badge" [ngClass]="item.estado">{{ estadoTexto[item.estado] }}</span>
              <span class="badge soft">{{ item.badge }}</span>
              <span *ngIf="item.alerta" class="alert-icon">{{ item.alerta }}</span>
              <span *ngIf="item.estado === 'aprobado'" class="status-icon" aria-label="Aprobado">‚úì</span>
            </div>
            <div class="grupo-alumnos">{{ item.descripcion }}</div>
            <div class="chips">
              <span class="chip">{{ item.fecha }}</span>
              <span class="chip ghost" *ngIf="item.proximoPaso">Pr√≥ximo paso: {{ item.proximoPaso }}</span>
            </div>
          </div>
        </li>
      </ul>
    </ng-container>

    <ng-template #sinEntregas>
      <p class="muted">A√∫n no tienes entregas registradas en {{ nivelTitulo() }}.</p>
    </ng-template>
  </ng-container>

      <ng-template #temasTpl>
        <div class="row-head">
          <h3>Temas para Trabajo de t√≠tulo</h3>
          <button class="btn primary" (click)="togglePostulacion(true)">
            + Postular / Proponer tema
          </button>
        </div>
        <p class="muted">Completa el formulario para solicitar o proponer un tema.</p>

      <!-- CORREGIDO: usa getter o bracket notation -->
    <div class="backdrop" *ngIf="showPostulacion()" (click)="togglePostulacion(false)"></div>
        <div class="modal" *ngIf="showPostulacion()" role="dialog" aria-modal="true">
        <div class="modal-head">
        <h4 class="ttl" style="margin: 0">Solicitud de Tema</h4>
        <button class="icon" (click)="togglePostulacion(false)" aria-label="Cerrar">‚úï</button>
      </div>

      <form [formGroup]="postulacionForm" (ngSubmit)="submitPostulacion()" class="grid" novalidate>
        <div class="field full">
          <label for="titulo">Nombre del tema <span class="req">*</span></label>
          <input id="titulo" type="text" formControlName="titulo" />
          <div class="err" *ngIf="hasError('titulo','required')">Obligatorio.</div>
          <div class="err" *ngIf="hasError('titulo','maxlength')">M√°x. 160 caracteres.</div>
        </div>

        <div class="field full">
          <label for="objetivo">Objetivo <span class="req">*</span></label>
          <input id="objetivo" type="text" formControlName="objetivo" />
          <div class="err" *ngIf="hasError('objetivo','required')">Obligatorio.</div>
          <div class="err" *ngIf="hasError('objetivo','maxlength')">M√°x. 300 caracteres.</div>
        </div>

        <div class="field full">
          <label for="descripcion">Breve descripci√≥n <span class="req">*</span></label>
          <textarea id="descripcion" rows="5" formControlName="descripcion"></textarea>
          <div class="err" *ngIf="hasError('descripcion','required')">Obligatorio.</div>
          <div class="err" *ngIf="hasError('descripcion','maxlength')">M√°x. 1200 caracteres.</div>
        </div>

        <div class="field">
          <label for="rama">Rama de la carrera <span class="req">*</span></label>
          <select id="rama" formControlName="rama">
            <option value="" disabled>Selecciona una rama</option>
            <option *ngFor="let r of ramas" [value]="r">{{ r }}</option>
          </select>
          <div class="err" *ngIf="hasError('rama','required')">Selecciona una rama.</div>
        </div>

        <div class="field">
          <label for="prof1">Profesor gu√≠a (Preferencia 1) <span class="req">*</span></label>
          <select id="prof1" formControlName="prof1">
            <option value="" disabled>Selecciona</option>
            <option *ngFor="let p of profesoresFiltrados()" [value]="p.id">{{ p.nombre }}</option>
          </select>
          <div class="err" *ngIf="hasError('prof1','required')">Selecciona una opci√≥n.</div>
        </div>

        <div class="field">
          <label for="prof2">Profesor gu√≠a (Preferencia 2)</label>
          <select id="prof2" formControlName="prof2">
            <option value="">(Opcional)</option>
            <option *ngFor="let p of profesoresFiltrados()" [value]="p.id">{{ p.nombre }}</option>
          </select>
        </div>

        <div class="field">
          <label for="prof3">Profesor gu√≠a (Preferencia 3)</label>
          <select id="prof3" formControlName="prof3">
            <option value="">(Opcional)</option>
            <option *ngFor="let p of profesoresFiltrados()" [value]="p.id">{{ p.nombre }}</option>
          </select>
        </div>

        <div class="field full" *ngIf="profesoresDuplicados">
          <span class="err">Las preferencias no pueden repetir al mismo profesor.</span>
        </div>

        <div class="actions full">
          <button type="button" class="btn light" (click)="togglePostulacion(false)">Cancelar</button>
          <button type="submit" class="btn primary">Enviar postulaci√≥n</button>
        </div>
      </form>
    </div>
  </ng-template>
</div>